<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>M-modeの実装 (1. CSRの実装) | Verylで作るCPU</title>
    <meta name="description" content="Write RISC-V CPU in Veryl">
    <meta name="generator" content="VitePress v2.0.0-alpha.12">
    <link rel="preload stylesheet" href="/assets/style.C620yUbE.css" as="style">
    <link rel="preload stylesheet" href="/vp-icons.css" as="style">
    
    <script type="module" src="/assets/app.DaMRq0wp.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/theme.CdosDlSo.js">
    <link rel="modulepreload" href="/assets/chunks/framework.BNheOMQd.js">
    <link rel="modulepreload" href="/assets/20-mmode-csr.md.ClifZ5c8.lean.js">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EM6HSGNSVY"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EM6HSGNSVY");</script>
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-1df9f90f><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0b0ada53></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0b0ada53>Skip to content</a><!--]--><!----><header class="VPNav" data-v-1df9f90f data-v-9f75dce3><div class="VPNavBar" data-v-9f75dce3 data-v-2a96a3d0><div class="wrapper" data-v-2a96a3d0><div class="container" data-v-2a96a3d0><div class="title" data-v-2a96a3d0><div class="VPNavBarTitle has-sidebar" data-v-2a96a3d0 data-v-1e38c6bc><a class="title" href="/" data-v-1e38c6bc><!--[--><!--]--><!----><span data-v-1e38c6bc>Verylで作るCPU</span><!--[--><!--]--></a></div></div><div class="content" data-v-2a96a3d0><div class="content-body" data-v-2a96a3d0><!--[--><!--]--><div class="VPNavBarSearch search" data-v-2a96a3d0><!--[--><!----><div id="local-search"><button type="button" aria-label="Search" aria-keyshortcuts="/ control+k meta+k" class="DocSearch DocSearch-Button"><span class="DocSearch-Button-Container"><span class="vpi-search DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key"></kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-2a96a3d0 data-v-39714824><span id="main-nav-aria-label" class="visually-hidden" data-v-39714824> Main Navigation </span><!--[--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-2a96a3d0 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-2a96a3d0 data-v-0394ad82 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://github.com/nananapo/veryl-riscv-book" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-2a96a3d0 data-v-bb2aa2f0 data-v-42cb505d><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-42cb505d><span class="vpi-more-horizontal icon" data-v-42cb505d></span></button><div class="menu" data-v-42cb505d><div class="VPMenu" data-v-42cb505d data-v-25a6cce8><!----><!--[--><!--[--><!----><div class="group" data-v-bb2aa2f0><div class="item appearance" data-v-bb2aa2f0><p class="label" data-v-bb2aa2f0>Appearance</p><div class="appearance-action" data-v-bb2aa2f0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bb2aa2f0 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><div class="group" data-v-bb2aa2f0><div class="item social-links" data-v-bb2aa2f0><div class="VPSocialLinks social-links-list" data-v-bb2aa2f0 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://github.com/nananapo/veryl-riscv-book" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-2a96a3d0 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-2a96a3d0><div class="divider-line" data-v-2a96a3d0></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-1df9f90f data-v-8acdfeb5><div class="container" data-v-8acdfeb5><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-8acdfeb5><span class="vpi-align-left menu-icon" data-v-8acdfeb5></span><span class="menu-text" data-v-8acdfeb5>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-8acdfeb5 data-v-0bf0e06f><button data-v-0bf0e06f>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-1df9f90f data-v-e7c6e512><div class="curtain" data-v-e7c6e512></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-e7c6e512><span class="visually-hidden" id="sidebar-aria-label" data-v-e7c6e512> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>第I部 RV32I/RV64Iの実装</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/00-preface.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>まえがき</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/02-setup.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>1 環境構築</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/03-veryl.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>2 ハードウェア記述言語 Veryl</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/04-impl-rv32i.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>3 RV32Iの実装</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/04a-zicsr.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>4 Zicsr拡張の実装</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/04b-riscvtests.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>5 riscv-testsによるテスト</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/05-impl-rv64i.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>6 RV64Iの実装</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/05a-pipeline.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>7 CPUのパイプライン化</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/05b-synth.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>8 CPUの合成</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>第II部 RV64IMACの実装</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/10-impl-m.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>9 M拡張の実装</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/11-impl-exception.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>10 例外の実装</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/12-impl-mmio.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>11 Memory-mapped I/Oの実装</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/13-impl-a.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>12 A拡張の実装</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/14-impl-c.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>13 C拡張の実装</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0 has-active" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>第III部 特権/割り込みの実装</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/20-mmode-csr.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>14 M-modeの実装 (1. CSRの実装)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/21-impl-interrupt.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>15 M-modeの実装 (2. 割り込みの実装)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/22-umode-csr.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>16 U-modeの実装</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/23-smode-csr.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>17 S-modeの実装 (1. CSRの実装)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/24-impl-paging.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>18 S-modeの実装 (2. 仮想記憶システム)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/25-impl-plic.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>19 PLICの実装</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/26-run-linux.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>20 Linuxを動かす</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/99-postface.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>あとがき (第Ⅰ部)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/99b-postface.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>あとがき (第Ⅱ部、第Ⅲ部)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/100-contribute.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>このプロジェクトに貢献する</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-1df9f90f data-v-aff0b8d7><div class="VPDoc has-sidebar has-aside" data-v-aff0b8d7 data-v-7011f0d8><!--[--><!--]--><div class="container" data-v-7011f0d8><div class="aside" data-v-7011f0d8><div class="aside-curtain" data-v-7011f0d8></div><div class="aside-container" data-v-7011f0d8><div class="aside-content" data-v-7011f0d8><div class="VPDocAside" data-v-7011f0d8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-60d5052e><div class="content" data-v-60d5052e><div class="outline-marker" data-v-60d5052e></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-60d5052e>On this page</div><ul class="VPDocOutlineItem root" data-v-60d5052e data-v-2d0bdf9b><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-7011f0d8><div class="content-container" data-v-7011f0d8><!--[--><!--]--><main class="main" data-v-7011f0d8><div style="position:relative;" class="vp-doc _20-mmode-csr" data-v-7011f0d8><div><h1 id="m-modeの実装-1-csrの実装" tabindex="-1">M-modeの実装 (1. CSRの実装) <a class="header-anchor" href="#m-modeの実装-1-csrの実装" aria-label="Permalink to “M-modeの実装 (1. CSRの実装)”">​</a></h1><h2 id="概要" tabindex="-1">概要 <a class="header-anchor" href="#概要" aria-label="Permalink to “概要”">​</a></h2><p>「第II部 RV64IMACの実装」では、RV64IMACと例外、メモリマップドI/Oを実装しました。 「第III部 特権/割り込みの実装」では、次の機能を実装します。</p><ul><li>特権レベル (M-mode、S-mode、U-mode)</li><li>仮想記憶システム(ページング)</li><li>割り込み(CLINT、PLIC)</li></ul><p>これらの機能を実装したCPUはOSを動かせる十分な機能を持っています。 第III部の最後ではLinuxを動かします。</p><h3 id="特権レベルとは何か" tabindex="-1">特権レベルとは何か？ <a class="header-anchor" href="#特権レベルとは何か" aria-label="Permalink to “特権レベルとは何か？”">​</a></h3><p>CPUで動くアプリケーションは様々ですが、 多くのアプリケーションはOS(Operating System、オペレーティングシステム)の上で動かすことを前提に作成されています。 「OSの上で動かす」とは、アプリケーションはOSの機能を使い、OSに管理されながら実行されるということです。</p><p>多くのOSはデバイスやメモリなどのリソースの管理を行い、簡単にそれを扱うためのインターフェースをアプリケーションに提供します。 また、アプリケーションのデータを別のアプリケーションから保護したり、 OSが提供する方法でしかデバイスにアクセスできなくするなどのセキュリティ機能も備えています。</p><p>セキュリティ機能を実現するためには、OSがアプリケーションを実行するときにCPUが提供する一部の機能を制限する機能が必要です。 RISC-Vでは、この機能を特権レベル(privilege level)という機能、枠組みによって提供しています。 ほとんどの特権レベルの機能はCSRを通じて提供されます。</p><p>特権レベルはM-mode、S-mode、U-modeの3種類<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>が用意されています。 それぞれの特権レベルは2ビットの数値で表すことができます(リスト1)。 数値が大きい方が高い特権レベルです。</p><p>高い特権レベルには低い特権レベルの機能を制限する機能があったり、高い特権レベルでしか利用できない機能が定義されています。</p><p>特権レベルを表す<code>PrivMode</code>型をeeiパッケージに定義してください (リスト1)。</p><p><span class="caption">▼リスト14.1: PrivMode型の定義 (eei.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/8982bc8da03fa0a47d8ba2494edb293b80e71e2b~1..8982bc8da03fa0a47d8ba2494edb293b80e71e2b#diff-11470b1e7d69c89ea3723d114583fe520f6d8482422a151ad706be8ab57ea6b7">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code><span class="hljs-keyword">enum</span> PrivMode: <span class="hljs-keyword">logic</span>&lt;<span class="hljs-number">2</span>&gt; {
    M = <span class="hljs-number">2&#39;b11</span>,
    S = <span class="hljs-number">2&#39;b01</span>,
    U = <span class="hljs-number">2&#39;b00</span>,
}
</code></pre></div><h3 id="特権レベルの実装順序" tabindex="-1">特権レベルの実装順序 <a class="header-anchor" href="#特権レベルの実装順序" aria-label="Permalink to “特権レベルの実装順序”">​</a></h3><p>RISC-VのCPUに特権レベルを実装するとき、表1のいずれかの構成にする必要があります。 特権レベルを実装していないときはM-modeだけが実装されているように扱います。</p><div id="privmode.kousei" class="table"><p class="caption">表14.1: RISC-VのCPUがとれる構成</p><table><tr class="hline"><th>存在する特権レベル</th><th>実装する章</th></tr><tr class="hline"><td>M-mode</td><td>第14章「M-modeの実装 (1. CSRの実装)」</td></tr><tr class="hline"><td>M-mode、U-mode</td><td>第16章「U-modeの実装」</td></tr><tr class="hline"><td>M-mode、S-mode、U-mode</td><td>第17章「S-modeの実装 (1. CSRの実装)」</td></tr></table></div> CPUがリセット(起動)したときの特権レベルはM-modeです。 現在の特権レベルを保持するレジスタをcsrunitモジュールに作成します ( リスト2、 リスト3 )。 <p><span class="caption">▼リスト14.2: 現在の特権レベルを示すレジスタの定義 (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/8982bc8da03fa0a47d8ba2494edb293b80e71e2b~1..8982bc8da03fa0a47d8ba2494edb293b80e71e2b#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code><span class="hljs-keyword">var</span> mode: PrivMode;
</code></pre></div><p><span class="caption">▼リスト14.3: レジスタをM-modeでリセットする (csrunit.veryl)</span></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code><span class="hljs-keyword">always_ff</span> {
    <span class="hljs-keyword">if_reset</span> {
         <span class="custom-hl-bold">mode    = PrivMode::M;</span>
</code></pre></div><p>本書で実装するM-modeのCSRのアドレスをすべて定義します (リスト4)。 本章ではこの中の一部のCSRを実装し、 新しく実装する機能で使うタイミングで他のCSRを解説、実装します</p><p><span class="caption">▼リスト14.4: CSRのアドレスを定義する (eei.veryl)</span></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code><span class="hljs-keyword">enum</span> CsrAddr: <span class="hljs-keyword">logic</span>&lt;<span class="hljs-number">12</span>&gt; {
    <span class="custom-hl-bold"><span class="hljs-comment">// Machine Information Registers</span></span>
    <span class="custom-hl-bold">MIMPID = <span class="hljs-number">12&#39;hf13</span>,</span>
    <span class="custom-hl-bold">MHARTID = <span class="hljs-number">12&#39;hf14</span>,</span>
    <span class="custom-hl-bold"><span class="hljs-comment">// Machine Trap Setup</span></span>
    <span class="custom-hl-bold">MSTATUS = <span class="hljs-number">12&#39;h300</span>,</span>
    <span class="custom-hl-bold">MISA = <span class="hljs-number">12&#39;h301</span>,</span>
    <span class="custom-hl-bold">MEDELEG = <span class="hljs-number">12&#39;h302</span>,</span>
    <span class="custom-hl-bold">MIDELEG = <span class="hljs-number">12&#39;h303</span>,</span>
    <span class="custom-hl-bold">MIE = <span class="hljs-number">12&#39;h304</span>,</span>
    MTVEC = <span class="hljs-number">12&#39;h305</span>,
    <span class="custom-hl-bold">MCOUNTEREN = <span class="hljs-number">12&#39;h306</span>,</span>
    <span class="custom-hl-bold"><span class="hljs-comment">// Machine Trap Handling</span></span>
    <span class="custom-hl-bold">MSCRATCH = <span class="hljs-number">12&#39;h340</span>,</span>
    MEPC = <span class="hljs-number">12&#39;h341</span>,
    MCAUSE = <span class="hljs-number">12&#39;h342</span>,
    MTVAL = <span class="hljs-number">12&#39;h343</span>,
    MIP = <span class="hljs-number">12&#39;h344</span>,
    <span class="custom-hl-bold"><span class="hljs-comment">// Machine Counter/Timers</span></span>
    <span class="custom-hl-bold">MCYCLE = <span class="hljs-number">12&#39;hB00</span>,</span>
    <span class="custom-hl-bold">MINSTRET = <span class="hljs-number">12&#39;hB02</span>,</span>
    <span class="hljs-comment">// Custom</span>
    LED = <span class="hljs-number">12&#39;h800</span>,
}
</code></pre></div><h3 id="xlenの定義" tabindex="-1">XLENの定義 <a class="header-anchor" href="#xlenの定義" aria-label="Permalink to “XLENの定義”">​</a></h3><p>M-modeのCSRの多くは、特権レベルがM-modeのときのXLENであるMXLENをビット幅として定義されています。 S-mode、U-modeのときのXLENはそれぞれSXLEN、UXLENと定義されており、<code>MXLEN &gt;= SXLEN &gt;= UXLEN</code>を満たします。 仕様上はmstatusレジスタを使用してSXLEN、UXLENを変更できるように実装できますが、 本書ではMXLEN、SXLEN、UXLENが常に<code>64</code>(eeiパッケージに定義しているXLEN)になるように実装します。</p><h2 id="misaレジスタ-machine-isa" tabindex="-1">misaレジスタ (Machine ISA) <a class="header-anchor" href="#misaレジスタ-machine-isa" aria-label="Permalink to “misaレジスタ (Machine ISA)”">​</a></h2><p><img src="/assets/misa.D7bM08t1.png" alt="misaレジスタ"> misaレジスタは、ハードウェアスレッドがサポートするISAを表すMXLENビットのレジスタです。 MXLフィールドにはMXLENを表す数値(表2)が格納されています。 Extensionsフィールドは下位ビットからそれぞれアルファベットのA、B、 Cと対応していて、 それぞれのビットはそのアルファベットが表す拡張(例えばA拡張ならAビット、C拡張ならC)が実装されているなら<code>1</code>に設定されています。 仕様上はExtensionsフィールドを書き換えられるように実装できますが、本書では書き換えられないようにします。</p><div id="numtolen" class="table"><p class="caption">表14.2: XLENと数値の対応</p><table><tr class="hline"><th>XLEN</th><th>数値</th></tr><tr class="hline"><td>32</td><td>1</td></tr><tr class="hline"><td>64</td><td>2</td></tr><tr class="hline"><td>128</td><td>3</td></tr></table></div> misaレジスタを作成し、読み込めるようにします ( リスト5、 リスト6 )。 CPUは`RV64IMAC`なのでMXLフィールドに`64`を表す`2`を設定し、 ExtensionsフィールドのM拡張(M)、基本整数命令セット(I)、C拡張(C)、A拡張(A)のビットを`1`にしています。 <p><span class="caption">▼リスト14.5: misaレジスタの定義 (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/3e445cc0afb630d7f79e659347000235de7a148e~1..3e445cc0afb630d7f79e659347000235de7a148e#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code><span class="hljs-keyword">let</span> misa  : UIntX = {<span class="hljs-number">2&#39;d2</span>, <span class="hljs-number">1&#39;b0</span> <span class="hljs-keyword">repeat</span> XLEN - <span class="hljs-number">28</span>, <span class="hljs-number">26&#39;b00000000000001000100000101</span>}; <span class="hljs-comment">// M, I, C, A</span>
</code></pre></div><p><span class="caption">▼リスト14.6: misaレジスタを読めるようにする (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/3e445cc0afb630d7f79e659347000235de7a148e~1..3e445cc0afb630d7f79e659347000235de7a148e#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code>rdata = <span class="hljs-keyword">case</span> csr_addr {
    <span class="custom-hl-bold">CsrAddr::MISA  : misa,</span>
</code></pre></div><p>これ以降、AというCSRのBフィールド、ビットのことをA.Bと表記することがあります。</p><h2 id="mimpidレジスタ-machine-implementation-id" tabindex="-1">mimpidレジスタ (Machine Implementation ID) <a class="header-anchor" href="#mimpidレジスタ-machine-implementation-id" aria-label="Permalink to “mimpidレジスタ (Machine Implementation ID)”">​</a></h2><p><img src="/assets/mimpid.DJStHHAp.png" alt="mimpidレジスタ"> mimpidレジスタは、プロセッサ実装のバージョンを表す値を格納しているMXLENビットのレジスタです。 値が<code>0</code>のときは、mimpidレジスタが実装されていないことを示します。</p><p>他にもプロセッサの実装の情報を表すレジスタ(mvendorid<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>、marchid<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>)がありますが、本書では実装しません。</p><p>せっかくなので、適当な値を設定しましょう。 eeiパッケージにIDを定義して、読み込めるようにします ( リスト7、 リスト8 )。</p><p><span class="caption">▼リスト14.7: IDを適当な値で定義する (eei.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/86725080ea1984223a2bcc557488d1651cc13d6a~1..86725080ea1984223a2bcc557488d1651cc13d6a#diff-11470b1e7d69c89ea3723d114583fe520f6d8482422a151ad706be8ab57ea6b7">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code><span class="hljs-comment">// Machine Implementation ID</span>
<span class="hljs-keyword">const</span> MACHINE_IMPLEMENTATION_ID: UIntX = <span class="hljs-number">1</span>;
</code></pre></div><p><span class="caption">▼リスト14.8: mipmidレジスタを読めるようにする (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/86725080ea1984223a2bcc557488d1651cc13d6a~1..86725080ea1984223a2bcc557488d1651cc13d6a#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code>rdata = <span class="hljs-keyword">case</span> csr_addr {
    CsrAddr::MISA  : misa,
    <span class="custom-hl-bold">CsrAddr::MIMPID: MACHINE_IMPLEMENTATION_ID,</span>
</code></pre></div><h2 id="mhartidレジスタ-hart-id" tabindex="-1">mhartidレジスタ (Hart ID) <a class="header-anchor" href="#mhartidレジスタ-hart-id" aria-label="Permalink to “mhartidレジスタ (Hart ID)”">​</a></h2><p><img src="/assets/mhartid.CkxHIail.png" alt="mhartidレジスタ"> mhartidレジスタは、今実行しているハードウェアスレッド(hart)のIDを格納しているMXLENビットのレジスタです。 複数のプロセッサ、ハードウェアスレッドが存在するときに、それぞれを区別するために使用します。 IDはどんな値でも良いですが、環境内にIDが<code>0</code>のハードウェアスレッドが1つ存在する必要があります。 基本編で作るCPUは1コア1ハードウェアスレッドであるためmhartidレジスタに<code>0</code>を設定します。</p><p>mhartレジスタを作成し、読み込めるようにします ( リスト9、 リスト10 )。</p><p><span class="caption">▼リスト14.9: mhartidレジスタの定義 (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/73d2fb645acf77ab15a6f4ed4ca5d7e75bac14f7~1..73d2fb645acf77ab15a6f4ed4ca5d7e75bac14f7#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code><span class="hljs-keyword">let</span> mhartid: UIntX = <span class="hljs-number">0</span>;
</code></pre></div><p><span class="caption">▼リスト14.10: mhartidレジスタを読めるようにする (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/73d2fb645acf77ab15a6f4ed4ca5d7e75bac14f7~1..73d2fb645acf77ab15a6f4ed4ca5d7e75bac14f7#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code>rdata = <span class="hljs-keyword">case</span> csr_addr {
    CsrAddr::MISA   : misa,
    CsrAddr::MIMPID : MACHINE_IMPLEMENTATION_ID,
    <span class="custom-hl-bold">CsrAddr::MHARTID: mhartid,</span>
</code></pre></div><h2 id="mstatusレジスタ-machine-status" tabindex="-1">mstatusレジスタ (Machine Status) <a class="header-anchor" href="#mstatusレジスタ-machine-status" aria-label="Permalink to “mstatusレジスタ (Machine Status)”">​</a></h2><p><img src="/assets/mstatus.BnsWH-ux.png" alt="mstatusレジスタ"> mstatusレジスタは、拡張の設定やトラップ、状態などを管理するMXLENビットのレジスタです。 基本編では図4に示しているフィールドを、そのフィールドが必要になったときに実装します。 とりあえず今のところは読み込みだけできるようにします ( リスト11、 リスト12、 リスト13、 リスト14、 リスト15、 リスト16 )。</p><p><span class="caption">▼リスト14.11: 書き込みマスクの定義 (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/f8a7054418c65ac2b3e0104bec02c51360dfbef5~1..f8a7054418c65ac2b3e0104bec02c51360dfbef5#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code><span class="hljs-keyword">const</span> MSTATUS_WMASK: UIntX = <span class="hljs-number">&#39;h0000_0000_0000_0000</span> <span class="hljs-keyword">as</span> UIntX;
</code></pre></div><p><span class="caption">▼リスト14.12: 書き込みマスクを設定する (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/f8a7054418c65ac2b3e0104bec02c51360dfbef5~1..f8a7054418c65ac2b3e0104bec02c51360dfbef5#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code>wmask = <span class="hljs-keyword">case</span> csr_addr {
    <span class="custom-hl-bold">CsrAddr::MSTATUS: MSTATUS_WMASK,</span>
</code></pre></div><p><span class="caption">▼リスト14.13: mstatusレジスタの定義 (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/f8a7054418c65ac2b3e0104bec02c51360dfbef5~1..f8a7054418c65ac2b3e0104bec02c51360dfbef5#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code><span class="hljs-keyword">var</span> mstatus: UIntX;
</code></pre></div><p><span class="caption">▼リスト14.14: mstatusレジスタを読めるようにする (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/f8a7054418c65ac2b3e0104bec02c51360dfbef5~1..f8a7054418c65ac2b3e0104bec02c51360dfbef5#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code>rdata = <span class="hljs-keyword">case</span> csr_addr {
    CsrAddr::MISA   : misa,
    CsrAddr::MIMPID : MACHINE_IMPLEMENTATION_ID,
    CsrAddr::MHARTID: mhartid,
    <span class="custom-hl-bold">CsrAddr::MSTATUS: mstatus,</span>
</code></pre></div><p><span class="caption">▼リスト14.15: mstatusレジスタのリセット (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/f8a7054418c65ac2b3e0104bec02c51360dfbef5~1..f8a7054418c65ac2b3e0104bec02c51360dfbef5#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code><span class="hljs-keyword">always_ff</span> {
    <span class="hljs-keyword">if_reset</span> {
        mode    = PrivMode::M;
        <span class="custom-hl-bold">mstatus = <span class="hljs-number">0</span>;</span>
</code></pre></div><p><span class="caption">▼リスト14.16: mstatusレジスタの書き込み (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/f8a7054418c65ac2b3e0104bec02c51360dfbef5~1..f8a7054418c65ac2b3e0104bec02c51360dfbef5#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code><span class="hljs-keyword">if</span> is_wsc {
    <span class="hljs-keyword">case</span> csr_addr {
        <span class="custom-hl-bold">CsrAddr::MSTATUS: mstatus = wdata;</span>
        CsrAddr::MTVEC  : mtvec   = wdata;
</code></pre></div><h2 id="ハードウェアパフォーマンスモニタ" tabindex="-1">ハードウェアパフォーマンスモニタ <a class="header-anchor" href="#ハードウェアパフォーマンスモニタ" aria-label="Permalink to “ハードウェアパフォーマンスモニタ”">​</a></h2><p>RISC-Vには、ハードウェアの性能評価指標を得るためにmcycleとminstret、それぞれ29個のmhpmcounter、mhpmeventレジスタが定義されています。 それぞれ次の値を得るために利用できます。</p><dl><dt>mcycleレジスタ (64ビット)</dt><dd> ハードウェアスレッドが起動(リセット)されてから経過したサイクル数 </dd><dt>minstretレジスタ (64ビット)</dt><dd> ハードウェアスレッドがリタイア(実行完了)した命令数 </dd><dt>mhpmcounter、mhpmeventレジスタ (64ビット)</dt><dd> mhpmeventレジスタで選択された指標がmhpmcounterレジスタに反映されます。 </dd></dl><p>基本編ではmcycle、minstretレジスタを実装します。 mhpmcounter、mhpmeventレジスタは表示するような指標がないため実装しません。 また、mcountinhibitレジスタを使うとカウントを停止するかを制御できますが、これも実装しません。</p><h3 id="mcycleレジスタ" tabindex="-1">mcycleレジスタ <a class="header-anchor" href="#mcycleレジスタ" aria-label="Permalink to “mcycleレジスタ”">​</a></h3><p>mcycleレジスタを定義して読み込めるようにします。 ( リスト17、 リスト18 )。</p><p><span class="caption">▼リスト14.17: mcycleレジスタの定義 (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/c3692525b4f2a50d48d89c158f8b7266a441820a~1..c3692525b4f2a50d48d89c158f8b7266a441820a#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code><span class="hljs-keyword">var</span> mcycle : UInt64;
</code></pre></div><p><span class="caption">▼リスト14.18: rdataの割り当てで、mcycleレジスタを読めるようにする (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/c3692525b4f2a50d48d89c158f8b7266a441820a~1..c3692525b4f2a50d48d89c158f8b7266a441820a#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code>CsrAddr::MCYCLE : mcycle,
</code></pre></div><p>always_ffブロックで、クロックごとに値を更新します ( リスト19 )。</p><p><span class="caption">▼リスト14.19: mcycleレジスタのリセットとインクリメント (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/c3692525b4f2a50d48d89c158f8b7266a441820a~1..c3692525b4f2a50d48d89c158f8b7266a441820a#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code><span class="hljs-keyword">always_ff</span> {
    <span class="hljs-keyword">if_reset</span> {
        mode    = PrivMode::M;
        mstatus = <span class="hljs-number">0</span>;
        mtvec   = <span class="hljs-number">0</span>;
        <span class="custom-hl-bold">mcycle  = <span class="hljs-number">0</span>;</span>
        mepc    = <span class="hljs-number">0</span>;
        mcause  = <span class="hljs-number">0</span>;
        mtval   = <span class="hljs-number">0</span>;
        led     = <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="custom-hl-bold">mcycle += <span class="hljs-number">1</span>;</span>
</code></pre></div><h3 id="minstretレジスタ" tabindex="-1">minstretレジスタ <a class="header-anchor" href="#minstretレジスタ" aria-label="Permalink to “minstretレジスタ”">​</a></h3><p>coreモジュールでinstretレジスタを作成し、 トラップが発生していない命令がWBステージに到達した場合にインクリメントします ( リスト20、 リスト21 )。</p><p><span class="caption">▼リスト14.20: minstretレジスタの定義 (core.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/4001850e8c6734dc8782b3baf19517376498ac87~1..4001850e8c6734dc8782b3baf19517376498ac87#diff-bdad1723f95a5423ff5ab8ba69bb572aabe1c8def0cda1748f6f980f61b57510">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code><span class="hljs-keyword">var</span> minstret        : UInt64;
</code></pre></div><p><span class="caption">▼リスト14.21: minstretレジスタのインクリメント (core.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/4001850e8c6734dc8782b3baf19517376498ac87~1..4001850e8c6734dc8782b3baf19517376498ac87#diff-bdad1723f95a5423ff5ab8ba69bb572aabe1c8def0cda1748f6f980f61b57510">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code><span class="hljs-keyword">always_ff</span> {
    <span class="hljs-keyword">if_reset</span> {
        minstret = <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> wbq_rvalid &amp;&amp; wbq_rready &amp;&amp; !wbq_rdata.raise_trap {
            minstret += <span class="hljs-number">1</span>;
        }
    }
}
</code></pre></div><p><code>minstret</code>の値をcsrunitモジュールに渡し、読み込めるようにします ( リスト22、 リスト23、 リスト24 )。</p><p><span class="caption">▼リスト14.22: csrunitモジュールのポートにminstretを追加する (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/4001850e8c6734dc8782b3baf19517376498ac87~1..4001850e8c6734dc8782b3baf19517376498ac87#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code>minstret   : <span class="hljs-keyword">input</span>  UInt64           ,
</code></pre></div><p><span class="caption">▼リスト14.23: csrunitモジュールのインスタンスにminstretレジスタを渡す (core.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/4001850e8c6734dc8782b3baf19517376498ac87~1..4001850e8c6734dc8782b3baf19517376498ac87#diff-bdad1723f95a5423ff5ab8ba69bb572aabe1c8def0cda1748f6f980f61b57510">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code>minstret                          ,
</code></pre></div><p><span class="caption">▼リスト14.24: minstretレジスタを読めるようにする (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/4001850e8c6734dc8782b3baf19517376498ac87~1..4001850e8c6734dc8782b3baf19517376498ac87#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code>CsrAddr::MCYCLE  : mcycle,
<span class="custom-hl-bold">CsrAddr::MINSTRET: minstret,</span>
CsrAddr::MEPC    : mepc,
</code></pre></div><p>csrunitモジュールはMRET命令でも<code>raise_trap</code>フラグを立てるため、 このままではMRET命令で<code>minstret</code>がインクリメントされません。 そのため、トラップから戻る命令であることを示すフラグをcsrunitモジュールに作成し、 正しくインクリメントされるようにします ( リスト25、 リスト26、 リスト27、 リスト28 )。</p><p><span class="caption">▼リスト14.25: csrunitモジュールのポートにtrap_returnを追加する (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/4001850e8c6734dc8782b3baf19517376498ac87~1..4001850e8c6734dc8782b3baf19517376498ac87#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code>trap_return: <span class="hljs-keyword">output</span> <span class="hljs-keyword">logic</span>            ,
</code></pre></div><p><span class="caption">▼リスト14.26: MRET命令の時にtrap_returnを1にする (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/4001850e8c6734dc8782b3baf19517376498ac87~1..4001850e8c6734dc8782b3baf19517376498ac87#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code><span class="custom-hl-bold"><span class="hljs-comment">// Trap Return</span></span>
<span class="custom-hl-bold"><span class="hljs-keyword">assign</span> trap_return = valid &amp;&amp; is_mret &amp;&amp; !raise_expt;</span>

<span class="hljs-comment">// Trap</span>
<span class="hljs-keyword">assign</span> raise_trap  = raise_expt || <span class="custom-hl-bold">trap_return</span>;
</code></pre></div><p><span class="caption">▼リスト14.27: csrunitモジュールのインスタンスからtrap_returnを受け取る (core.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/4001850e8c6734dc8782b3baf19517376498ac87~1..4001850e8c6734dc8782b3baf19517376498ac87#diff-bdad1723f95a5423ff5ab8ba69bb572aabe1c8def0cda1748f6f980f61b57510">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code>trap_return: csru_trap_return     ,
</code></pre></div><p><span class="caption">▼リスト14.28: MRET命令ならraise_trapフラグを立てないようにする (core.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/4001850e8c6734dc8782b3baf19517376498ac87~1..4001850e8c6734dc8782b3baf19517376498ac87#diff-bdad1723f95a5423ff5ab8ba69bb572aabe1c8def0cda1748f6f980f61b57510">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code>wbq_wdata.raise_trap = csru_raise_trap <span class="custom-hl-bold">&amp;&amp; !csru_trap_return;</span>
</code></pre></div><h2 id="mscratchレジスタ-machine-scratch" tabindex="-1">mscratchレジスタ (Machine Scratch) <a class="header-anchor" href="#mscratchレジスタ-machine-scratch" aria-label="Permalink to “mscratchレジスタ (Machine Scratch)”">​</a></h2><p><img src="/assets/mscratch.Cf4y9m1d.png" alt="mscratchレジスタ"> mscratchレジスタは、M-modeのときに自由に読み書きできるMXLENビットのレジスタです。</p><p>mscratchレジスタの典型的な用途はコンテキストスイッチです。 コンテキストスイッチとは、実行しているアプリケーションAを別のアプリケーションBに切り替えることを指します。 多くの場合、コンテキストスイッチはトラップによって開始しますが、 Aの実行途中の状態(レジスタの値)を保存しないとAを実行再開できなくなります。 そのため、コンテキストスイッチが始まったとき、つまりトラップが発生したときにレジスタの値をメモリに保存する必要があります。 しかし、ストア命令はアドレスの指定にレジスタの値を使うため、 アドレスの指定のために少なくとも1つのレジスタの値を犠牲にしなければならず、 すべてのレジスタの値を完全に保存できません<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup>。</p><p>この問題を回避するために、一時的な値の保存場所としてmscratchレジスタが使用されます。 事前にmscratchレジスタにメモリアドレス(やメモリアドレスを得るための情報)を格納しておき、 CSRRW命令でmscratchレジスタの値とレジスタの値を交換することで任意の場所にレジスタの値を保存できます。</p><p>mscratchレジスタを定義し、自由に読み書きできるようにします ( リスト29、 リスト30、 リスト31、 リスト32、 リスト33、 リスト34 )。</p><p><span class="caption">▼リスト14.29: mscratchレジスタの定義 (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/27772fbc85ebf05211129febfeb31f8e4e122fd7~1..27772fbc85ebf05211129febfeb31f8e4e122fd7#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code><span class="hljs-keyword">var</span> mcycle  : UInt64;
<span class="custom-hl-bold"><span class="hljs-keyword">var</span> mscratch: UIntX ;</span>
<span class="hljs-keyword">var</span> mepc    : UIntX ;
</code></pre></div><p><span class="caption">▼リスト14.30: mscratchレジスタを0でリセットする (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/27772fbc85ebf05211129febfeb31f8e4e122fd7~1..27772fbc85ebf05211129febfeb31f8e4e122fd7#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code>mtvec    = <span class="hljs-number">0</span>;
<span class="custom-hl-bold">mscratch = <span class="hljs-number">0</span>;</span>
mcycle   = <span class="hljs-number">0</span>;
</code></pre></div><p><span class="caption">▼リスト14.31: mscratchレジスタを読めるようにする (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/27772fbc85ebf05211129febfeb31f8e4e122fd7~1..27772fbc85ebf05211129febfeb31f8e4e122fd7#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code>CsrAddr::MINSTRET: minstret,
<span class="custom-hl-bold">CsrAddr::MSCRATCH: mscratch,</span>
CsrAddr::MEPC    : mepc,
</code></pre></div><p><span class="caption">▼リスト14.32: 書き込みマスクの定義 (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/27772fbc85ebf05211129febfeb31f8e4e122fd7~1..27772fbc85ebf05211129febfeb31f8e4e122fd7#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code><span class="hljs-keyword">const</span> MTVEC_WMASK   : UIntX = <span class="hljs-number">&#39;hffff_ffff_ffff_fffc</span>;
<span class="custom-hl-bold"><span class="hljs-keyword">const</span> MSCRATCH_WMASK: UIntX = <span class="hljs-number">&#39;hffff_ffff_ffff_ffff</span>;</span>
<span class="hljs-keyword">const</span> MEPC_WMASK    : UIntX = <span class="hljs-number">&#39;hffff_ffff_ffff_fffe</span>;
</code></pre></div><p><span class="caption">▼リスト14.33: 書き込みマスクをwmaskに割り当てる (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/27772fbc85ebf05211129febfeb31f8e4e122fd7~1..27772fbc85ebf05211129febfeb31f8e4e122fd7#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code>CsrAddr::MTVEC   : MTVEC_WMASK,
<span class="custom-hl-bold">CsrAddr::MSCRATCH: MSCRATCH_WMASK,</span>
CsrAddr::MEPC    : MEPC_WMASK,
</code></pre></div><p><span class="caption">▼リスト14.34: mscratchレジスタの書き込み (csrunit.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/27772fbc85ebf05211129febfeb31f8e4e122fd7~1..27772fbc85ebf05211129febfeb31f8e4e122fd7#diff-44dd9efb5b2797bbd5248f96206e5f13442629b6dd3cda87990e383f99c2aeec">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code>CsrAddr::MTVEC   : mtvec    = wdata;
<span class="custom-hl-bold">CsrAddr::MSCRATCH: mscratch = wdata;</span>
CsrAddr::MEPC    : mepc     = wdata;
</code></pre></div><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p>V拡張が実装されている場合、さらに仮想化のための特権レベルが定義されます。 <a href="#fnref1" class="footnote-backref">↩︎</a></p></li><li id="fn2" class="footnote-item"><p>製造業者のID(JEDEC ID)を格納します <a href="#fnref2" class="footnote-backref">↩︎</a></p></li><li id="fn3" class="footnote-item"><p>マイクロアーキテクチャの種類を示すIDを格納します <a href="#fnref3" class="footnote-backref">↩︎</a></p></li><li id="fn4" class="footnote-item"><p>x0と即値を使うとアドレス0付近にすべてのレジスタの値を保存できますが、一般的な方法ではありません <a href="#fnref4" class="footnote-backref">↩︎</a></p></li></ol></section></div></div></main><footer class="VPDocFooter" data-v-7011f0d8 data-v-e257564d><!--[--><!--]--><!----><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-e257564d><span class="visually-hidden" id="doc-footer-aria-label" data-v-e257564d>Pager</span><div class="pager" data-v-e257564d><a class="VPLink link pager-link prev" href="/14-impl-c.html" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Previous page</span><span class="title" data-v-e257564d>13 C拡張の実装</span><!--]--></a></div><div class="pager" data-v-e257564d><a class="VPLink link pager-link next" href="/21-impl-interrupt.html" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Next page</span><span class="title" data-v-e257564d>15 M-modeの実装 (2. 割り込みの実装)</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"00-preface.md\":\"CYEphBX8\",\"02-setup.md\":\"da1pIHNs\",\"03-veryl.md\":\"VOHmUq3V\",\"04-impl-rv32i.md\":\"En9oxyTy\",\"04a-zicsr.md\":\"bb6l3EMf\",\"04b-riscvtests.md\":\"oxWN38vg\",\"05-impl-rv64i.md\":\"BeSvLJzL\",\"05a-pipeline.md\":\"DuXYi08s\",\"05b-synth.md\":\"C61u6gEa\",\"10-impl-m.md\":\"-9npfSbI\",\"100-contribute.md\":\"DBSud0cg\",\"11-impl-exception.md\":\"0cjXHDnt\",\"12-impl-mmio.md\":\"DEZ4STaS\",\"13-impl-a.md\":\"VDUHO1Tc\",\"14-impl-c.md\":\"Bh3CTsu3\",\"20-mmode-csr.md\":\"ClifZ5c8\",\"21-impl-interrupt.md\":\"CuNYTmi5\",\"22-umode-csr.md\":\"CImixLe6\",\"23-smode-csr.md\":\"Bg63IDTu\",\"24-impl-paging.md\":\"B7K6vTYe\",\"25-impl-plic.md\":\"C-IgoZUO\",\"26-run-linux.md\":\"CwWfT7wp\",\"99-postface.md\":\"DKyCFrvU\",\"99b-postface.md\":\"Cxpm5DbS\",\"index.md\":\"DsKG6qhs\"}");function deserializeFunctions(r){return Array.isArray(r)?r.map(deserializeFunctions):typeof r=="object"&&r!==null?Object.keys(r).reduce((t,n)=>(t[n]=deserializeFunctions(r[n]),t),{}):typeof r=="string"&&r.startsWith("_vp-fn_")?new Function(`return ${r.slice(7)}`)():r};window.__VP_SITE_DATA__=deserializeFunctions(JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Verylで作るCPU\",\"description\":\"Write RISC-V CPU in Veryl\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[],\"sidebar\":[{\"text\":\"第I部 RV32I/RV64Iの実装\",\"items\":[{\"text\":\"まえがき\",\"link\":\"/00-preface\"},{\"text\":\"1 環境構築\",\"link\":\"/02-setup\"},{\"text\":\"2 ハードウェア記述言語 Veryl\",\"link\":\"/03-veryl\"},{\"text\":\"3 RV32Iの実装\",\"link\":\"/04-impl-rv32i\"},{\"text\":\"4 Zicsr拡張の実装\",\"link\":\"/04a-zicsr\"},{\"text\":\"5 riscv-testsによるテスト\",\"link\":\"/04b-riscvtests\"},{\"text\":\"6 RV64Iの実装\",\"link\":\"/05-impl-rv64i\"},{\"text\":\"7 CPUのパイプライン化\",\"link\":\"/05a-pipeline\"},{\"text\":\"8 CPUの合成\",\"link\":\"/05b-synth\"}]},{\"text\":\"第II部 RV64IMACの実装\",\"items\":[{\"text\":\"9 M拡張の実装\",\"link\":\"/10-impl-m\"},{\"text\":\"10 例外の実装\",\"link\":\"/11-impl-exception\"},{\"text\":\"11 Memory-mapped I/Oの実装\",\"link\":\"/12-impl-mmio\"},{\"text\":\"12 A拡張の実装\",\"link\":\"/13-impl-a\"},{\"text\":\"13 C拡張の実装\",\"link\":\"/14-impl-c\"}]},{\"text\":\"第III部 特権/割り込みの実装\",\"items\":[{\"text\":\"14 M-modeの実装 (1. CSRの実装)\",\"link\":\"/20-mmode-csr\"},{\"text\":\"15 M-modeの実装 (2. 割り込みの実装)\",\"link\":\"/21-impl-interrupt\"},{\"text\":\"16 U-modeの実装\",\"link\":\"/22-umode-csr\"},{\"text\":\"17 S-modeの実装 (1. CSRの実装)\",\"link\":\"/23-smode-csr\"},{\"text\":\"18 S-modeの実装 (2. 仮想記憶システム)\",\"link\":\"/24-impl-paging\"},{\"text\":\"19 PLICの実装\",\"link\":\"/25-impl-plic\"},{\"text\":\"20 Linuxを動かす\",\"link\":\"/26-run-linux\"},{\"text\":\"あとがき (第Ⅰ部)\",\"link\":\"/99-postface\"},{\"text\":\"あとがき (第Ⅱ部、第Ⅲ部)\",\"link\":\"/99b-postface\"},{\"text\":\"このプロジェクトに貢献する\",\"link\":\"/100-contribute\"}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/nananapo/veryl-riscv-book\"}],\"outline\":{\"level\":[2,4]},\"search\":{\"provider\":\"local\",\"options\":{\"miniSearch\":{\"options\":{\"tokenize\":\"_vp-fn_(term) => {\\n              if (typeof term === \\\"string\\\") term = term.toLowerCase();\\n              const segmenter = Intl.Segmenter && new Intl.Segmenter(\\\"ja-JP\\\", { granularity: \\\"word\\\" });\\n              if (!segmenter) return [term];\\n              const tokens = [];\\n              for (const seg of segmenter.segment(term)) {\\n                if (seg.segment.trim() !== \\\"\\\") tokens.push(seg.segment);\\n              }\\n              return tokens;\\n            }\"}}}}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false,\"additionalConfig\":{}}"));</script>
    
  </body>
</html>