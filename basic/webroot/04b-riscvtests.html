<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>riscv-testsによるテスト | Verylで作るRISC-V CPU</title>
    <link rel="stylesheet" type="text/css" href="css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="css/webstyle.css" />
    <link rel="next" title="RV64Iの実装" href="05-impl-rv64i.html">
    <link rel="prev" title="Zicsr拡張の実装" href="04a-zicsr.html">
    <meta name="generator" content="Re:VIEW Starter">
  </head>
  <body>
    <div class="page-outer">
      <div class="side-content">
                <a class="nav-title" href="index.html">Verylで作るRISC-V CPU</a>
<ul class="toc toc-1">
    <li class="toc-chapter"><a href="./00-preface.html">まえがき / はじめに</a></li>
    <li class="toc-chapter"><a href="./01-intro.html">Intro</a></li>
<li class="toc-part">第I部 基本編
  <ul class="toc toc-2">
    <li class="toc-chapter"><a href="./02-setup.html">1 環境構築</a></li>
    <li class="toc-chapter"><a href="./03-veryl.html">2 ハードウェア記述言語 Veryl</a></li>
    <li class="toc-chapter"><a href="./04-impl-rv32i.html">3 RV32Iの実装</a></li>
    <li class="toc-chapter"><a href="./04a-zicsr.html">4 Zicsr拡張の実装</a></li>
    <li class="toc-chapter"><a href="./04b-riscvtests.html">5 riscv-testsによるテスト</a>
      <ul class="toc toc-3">
        <li class="toc-section"><a href="#h5-1">5.1 riscv-testsとは何か？</a></li>
        <li class="toc-section"><a href="#h5-2">5.2 riscv-testsのビルド</a></li>
        <li class="toc-section"><a href="#h5-3">5.3 どのようにテストを実行するのか</a></li>
        <li class="toc-section"><a href="#h5-4">5.4 mcauseレジスタの実装</a></li>
        <li class="toc-section"><a href="#h5-5">5.5 riscv-testsの終了を検知する</a></li>
        <li class="toc-section"><a href="#h5-6">5.6 テストの実行</a></li>
        <li class="toc-section"><a href="#h5-7">5.7 複数のテストを自動で実行する</a></li>
      </ul>
    </li>
    <li class="toc-chapter"><a href="./05-impl-rv64i.html">6 RV64Iの実装</a></li>
  </ul>
</li>
<li class="toc-part">第II部 基本的な拡張とトラップの実装
  <ul class="toc toc-2">
    <li class="toc-chapter"><a href="./06-impl-M.html">7 M拡張の実装</a></li>
    <li class="toc-chapter"><a href="./07-impl-exception.html">8 例外の実装</a></li>
    <li class="toc-chapter"><a href="./08-impl-A.html">9 A拡張の実装</a></li>
    <li class="toc-chapter"><a href="./09-impl-C.html">10 C拡張の実装</a></li>
    <li class="toc-chapter"><a href="./10-impl-MMIO.html">11 MMIOの実装</a></li>
    <li class="toc-chapter"><a href="./11-impl-interrupt.html">12 割り込みの実装</a></li>
  </ul>
</li>
<li class="toc-part">第III部 privilege modeの実装
  <ul class="toc toc-2">
    <li class="toc-chapter"><a href="./12-impl-mmode-csr.html">13 M-modeの実装</a></li>
    <li class="toc-chapter"><a href="./13-impl-smode-csr.html">14 S-modeの実装</a></li>
    <li class="toc-chapter"><a href="./14-impl-paging.html">15 ページングの実装</a></li>
  </ul>
</li>
<li class="toc-part">第IV部 OSを動かす
  <ul class="toc toc-2">
    <li class="toc-chapter"><a href="./15-impl-virtio.html">16 virtioの実装</a></li>
    <li class="toc-chapter"><a href="./16-run-xv6.html">17 xv6の実行</a></li>
  </ul>
</li>
    <li class="toc-chapter"><a href="./99-postface.html">あとがき / おわりに</a></li>
</ul>
      </div>
      <div class="page-inner">
        <header class="page-header">
        </header>
        <main class="page-main">
<h1 class="boldlines center twolines"><a id="h5"></a><span class="secno">第5章</span> <br/>riscv-testsによるテスト</h1>
<p>前の章で、RV32IのCPUを実装しました。簡単なテストを作成して操作を確かめましたが、まだテストできていない命令が複数あります。そこで、riscv-testsというテストを利用することで、CPUがある程度正しく動いているらしいことを確かめます。</p>

<h2 class="numbox"><a id="h5-1"></a><span class="secno">5.1</span> riscv-testsとは何か？</h2>
<p>riscv-testsは、次のURLからソースコードをダウンロードすることができます。</p>
<p>riscv-software-src/riscv-tests : <a href="https://github.com/riscv-software-src/riscv-tests" class="link">https://github.com/riscv-software-src/riscv-tests</a></p>
<p>riscv-testsは、RISC-Vのプロセッサ向けのユニットテストやベンチマークの集合です。各命令や機能ごとにテストが用意されており、これを利用することで簡単に実装を確かめることができます。</p>
<p>すべての命令のすべての場合を網羅するようなテストではないため、riscv-testsをパスしても、確実に実装が正しいとは言えないことに注意してください。</p>

<h2 class="numbox"><a id="h5-2"></a><span class="secno">5.2</span> riscv-testsのビルド</h2>
<div class="miniblock miniblock-info">
<p class="miniblock-caption">riscv-testsのビルドが面倒、もしくはよく分からなくなってしまった方へ</p>
<p><a href="https://github.com/nananapo/riscv-tests-bin/tree/bin4" class="link">https://github.com/nananapo/riscv-tests-bin/tree/bin4</a></p>
<p>完成品を上記のURLにおいておきます。core/test/riscv-tests以下にコピーしてください。</p>
</div>

<h3 class="none"><a id="h5-2-1"></a><span class="secno">5.2.1</span> riscv-testsのビルド</h3>
<p>riscv-testsをcloneします。</p>
<div id="riscvtests.build" class="cmd-code">
<span class="caption">リスト5.1: リスト5.1: riscv-testsのclone</span>
<pre class="list language-build">$ <span class="userinput">git clone https://github.com/riscv-software-src/riscv-tests</span>
$ <span class="userinput">cd riscv-tests</span>
$ <span class="userinput">git submodule update --init --recursive</span>
</pre>
</div>
<p>riscv-testsは、プログラムの実行が<code class="inline-code">0x80000000</code>から始まると仮定した設定になっています。しかし、今のところCPUはアドレス<code class="inline-code">0x00000000</code>から実行を開始するため、リンカにわたす設定(<code class="inline-code">env/p/link.ld</code>)を変更します。</p>
<div id="link.ld" class="caption-code">
<span class="caption">リスト5.2: リスト5.2: riscv-tests/env/p/link.ld</span>
<pre class="list language-ld">OUTPUT_ARCH( &quot;riscv&quot; )
ENTRY(_start)

SECTIONS
{
  . = 0x00000000; <span class="balloon">← 先頭を0x00000000に変更する</span>
</pre>
</div>
<p>CPUのVerylプロジェクトのディレクトリ名をcoreとします。riscv-testsをビルドする前に、coreの中に、riscv-testsの成果物を保存するディレクトリを作成します。</p>
<div id="riscvtests.target" class="cmd-code">
<span class="caption">リスト5.3: リスト5.3: testディレクトリの作成</span>
<pre class="list language-target">$ <span class="userinput">cd core</span>
$ <span class="userinput">mkdir test</span>
</pre>
</div>
<p>riscv-testsをビルドします。</p>
<div id="riscvtests.autoconf" class="cmd-code">
<span class="caption">リスト5.4: リスト5.4: riscv-testsのビルド</span>
<pre class="list language-autoconf">$ <span class="userinput">cd riscv-testsをcloneしたディレクトリ</span>
$ <span class="userinput">autoconf</span>
$ <span class="userinput">./configure --prefix=core/testへのパス</span>
$ <span class="userinput">make</span>
$ <span class="userinput">make install</span>
</pre>
</div>
<p>core/testに、share/riscv-tests/isaが作成されます。</p>

<h3 class="none"><a id="h5-2-2"></a><span class="secno">5.2.2</span> 成果物を$readmemhで読み込める形式に変換する</h3>
<p>riscv-testsをビルドすることができましたが、これは<code class="inline-code">$readmemh</code>システムタスクで読み込める形式(以降HEX形式と呼びます)ではありません。</p>
<p>CPUでテストを実行できるように、ビルドしたテストのバイナリファイルをHEX形式に変換します。</p>
<p>まず、バイナリファイルをHEX形式に変換するPythonプログラム<code class="inline-code">test/bin2hex.py</code>を作成します。</p>
<div id="bin2hex.py" class="caption-code">
<span class="caption">リスト5.5: リスト5.5: core/test/bin2hex.py</span>
<pre class="list language-py">
</pre>
</div>
<p>このプログラムは、第二引数に指定されるバイナリファイルを、第一引数に与えられた数のバイト毎に区切り、16進数のテキストで出力します。</p>
<p>例えば<code class="inline-code">test/share/riscv-tests/isa/rv32ui-p-add</code>はELFファイルです。CPUはELFを直接に実行する機能を持っていないため、<code class="inline-code">riscv64-unknown-elf-objcopy</code>を利用して、ELFファイルを余計な情報を取り除いたバイナリファイルに変換します。</p>
<div id="elf.bin" class="cmd-code">
<span class="caption">リスト5.6: リスト5.6: ELFファイルを変換する</span>
<pre class="list language-bin">$ <span class="userinput">find share/ -type f -not -name &quot;*.dump&quot; -exec riscv32-unknown-elf-objcopy -O binary {} {}.bin \;</span>
</pre>
</div>
<p>変換されたバイナリファイルを、PythonプログラムでHEXファイルに変換します。</p>
<div id="bin.hex" class="cmd-code">
<span class="caption">リスト5.7: リスト5.7: バイナリファイルをHEXファイルに変換する</span>
<pre class="list language-hex">$ <span class="userinput">find share/ -type f -name &quot;*.bin&quot; -exec python3 bin2hex.py 4 {} \;</span>
</pre>
</div>

<h2 class="numbox"><a id="h5-3"></a><span class="secno">5.3</span> どのようにテストを実行するのか</h2>
<p>riscv-testsには複数のテストが用意されていますが、本章では、名前が<code class="inline-code">rv32ui-p-</code>から始まるRV32I向けのテストを利用します。</p>
<p>例えば、ADD命令のテストである<code class="inline-code">rv32ui-p-add.dump</code>を読んでみます。<code class="inline-code">rv32ui-p-add.dump</code>は、<code class="inline-code">rv32ui-p-add</code>のダンプファイルです。</p>
<div id="rv32ui-p-add.dump" class="caption-code">
<span class="caption">リスト5.8: リスト5.8: rv32ui-p-add.dump</span>
<pre class="list language-dump">Disassembly of section .text.init:

00000000 &lt;_start&gt;:
   0:   0500006f                j       50 &lt;reset_vector&gt;

00000004 &lt;trap_vector&gt;:
   4:   34202f73                csrr    t5,mcause <span class="balloon">← t5 = mcause</span>
  ...
  18:   00b00f93                li      t6,11
  1c:   03ff0063                beq     t5,t6,3c &lt;write_tohost&gt;
  ...

0000003c &lt;write_tohost&gt;: <span class="balloon">← 0x1000にテスト結果を書き込む</span>
  3c:   00001f17                auipc   t5,0x1
  40:   fc3f2223                sw      gp,-60(t5) # 1000 &lt;tohost&gt;
  ...

00000050 &lt;reset_vector&gt;:
  50:   00000093                li      ra,0
 ...    <span class="balloon">← レジスタ値のゼロ初期化</span>
  c8:   00000f93                li      t6,0
 ...    <span class="balloon">← ↓mtvecにtrap_vectorのアドレスを書き込む</span>
 130:   00000297                auipc   t0,0x0
 134:   ed428293                addi    t0,t0,-300 # 4 &lt;trap_vector&gt;
 138:   30529073                csrw    mtvec,t0
 ...    <span class="balloon">← ↓mepcにtest_2のアドレスを書き込む</span>
 178:   00000297                auipc   t0,0x0
 17c:   01428293                addi    t0,t0,20 # 18c &lt;test_2&gt;
 180:   34129073                csrw    mepc,t0
 ...    <span class="balloon">← ↓mretを実行し、mepcのアドレス=test_2にジャンプする</span>
 188:   30200073                mret

0000018c &lt;test_2&gt;: <span class="balloon">← 0 + 0 = 0のテスト</span>
 18c:   00200193                li      gp,2 <span class="balloon">← gp = 2</span>
 190:   00000593                li      a1,0
 194:   00000613                li      a2,0
 198:   00c58733                add     a4,a1,a2
 19c:   00000393                li      t2,0
 1a0:   4c771663                bne     a4,t2,66c &lt;fail&gt;
 ...
0000066c &lt;fail&gt;: <span class="balloon">← 失敗したときのジャンプ先</span>
 ... <span class="balloon">← ↓gpを1以外の値にする</span>
 674:   00119193                sll     gp,gp,0x1
 678:   0011e193                or      gp,gp,1
 ...
 684:   00000073                ecall

00000688 &lt;pass&gt;: <span class="balloon">← すべてのテストに成功したときのジャンプ先</span>
 ...
 68c:   00100193                li      gp,1 <span class="balloon">← gp = 1</span>
 690:   05d00893                li      a7,93
 694:   00000513                li      a0,0
 698:   00000073                ecall
 69c:   c0001073                unimp
</pre>
</div>
<p>riscv-testsは、基本的に次のような流れで実行されます。</p>
<ol start="1" type="1">
<li>_start : reset_vectorにジャンプする</li>
<li>reset_vector : 各種状態を初期化する</li>
<li>test_* : テストを実行する。命令の結果がおかしかったらfailに飛ぶ。最後まで正常に実行できたらpassに飛ぶ。</li>
<li>fail, pass : テストの成否をレジスタに書き込み、trap_vectorに飛ぶ</li>
<li>trap_vector : write_tohostに飛ぶ</li>
<li>write_tohost : テスト結果をメモリに書き込む。ここでループする</li>
</ol>
<p>_startから実行を開始し、最終的にwrite_tohostに移動します。テスト結果はメモリの<code class="inline-code">0x1000</code>に書き込まれます。</p>
<p><code class="inline-code">mcause</code>, <code class="inline-code">mtvec</code>, <code class="inline-code">mepc</code>はCSRです。riscv-testsの実装には少なくともこの3つの実装が必要です。</p>

<h2 class="numbox"><a id="h5-4"></a><span class="secno">5.4</span> mcauseレジスタの実装</h2>

<h2 class="numbox"><a id="h5-5"></a><span class="secno">5.5</span> riscv-testsの終了を検知する</h2>
<p>riscv-testsが終了したことを検知し、それが成功か失敗かどうかを報告する必要があります。</p>
<p>riscv-testsは終了したことを示すためにメモリのあああ番地に値を書き込みます。この値が1のとき、riscv-testsが正常に終了したことを示します。それ以外の時は、riscv-testsが失敗したことを示します。</p>
<p>riscv-testsの終了の検知処理をtopモジュールに記述します。</p>
<p>プログラム</p>

<h2 class="numbox"><a id="h5-6"></a><span class="secno">5.6</span> テストの実行</h2>
<p>試しにaddのテストを実行してみましょう。add命令のテストはrv32ui-p-add.bin.hexに格納されています。これを、メモリのreadmemhで読み込むファイルに指定します。</p>
<p>プログラム</p>
<p>ビルドして実行し、正常に動くことを確認します。</p>

<h2 class="numbox"><a id="h5-7"></a><span class="secno">5.7</span> 複数のテストを自動で実行する</h2>
<p>add以外の命令もテストしたいですが、そのためにreadmemhを書き換えるのは大変です。これを簡単にするために、readmemhにはマクロで指定する定数を渡します。</p>
<p>プログラム</p>
<p>自動でテストを実行し、その結果を報告するプログラムを作成します。</p>
<p>プログラム</p>
<p>このPythonプログラムは、riscv-testsフォルダにあるhexファイルについてテストを実行し、結果を報告します。引数に対象としたいプログラムの名前の一部を指定することができます。</p>
<p>今回はRV32Iのテストを実行したいので、riscv-testsのRV32I向けのテストの接頭辞であるrv32ui-p-引数に指定すると、次のように表示されます。</p>

        </main>
        <nav class="page-navi">
          <a href="04a-zicsr.html" class="page-prev">&#9664;</a>
          <a href="05-impl-rv64i.html" class="page-next">&#9654;</a>
        </nav>
        <footer>
        </footer>
      </div>
    </div>
  </body>
</html>
<!-- layout.html5.erb -->
