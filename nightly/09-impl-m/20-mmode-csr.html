<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    
    <title>M-modeの実装 (1. CSRの実装) | Verylで作るCPU</title>

    <link rel="stylesheet" type="text/css" href="css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="css/webstyle.css" />
    <link rel="next" title="M-modeの実装 (2. 割り込みの実装)" href="21-impl-interrupt.html">
    <link rel="prev" title="C拡張の実装" href="14-impl-c.html">
    <meta name="generator" content="Re:VIEW Starter">

    <script async defer src="https://buttons.github.io/buttons.js"></script>

  </head>
  <body style="background-color:#eff4ff">
    <div class="page-outer" style="background-color:white">
      <div class="side-content">
                <a class="nav-title" href="index.html">Verylで作るCPU</a>

        <div style="display:flex; gap:10px; align-items: center;">
          <a class="github-button" href="https://github.com/nananapo/veryl-riscv-book" data-color-scheme="no-preference: light_high_contrast; light: light; dark: dark;" data-size="large" data-show-count="true" aria-label="Star nananapo/veryl-riscv-book on GitHub">Star</a>
          <div style="">
            <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a>
          </div>
          <div style="margin-bottom: 14px;" id="share-facebook" class="fb-share-button" data-href="" data-layout="" data-size=""><a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Finvalid.invalid%2F&amp;src=sdkpreparse" class="fb-xfbml-parse-ignore">Facebookでシェアする</a></div>
        </div>
        <ul class="toc toc-1">
<li class="toc-part">第I部 RV64IMACの実装
  <ul class="toc toc-2">
    <li class="toc-chapter"><a href="./10-impl-m.html">1 M拡張の実装</a></li>
    <li class="toc-chapter"><a href="./11-impl-exception.html">2 例外の実装</a></li>
    <li class="toc-chapter"><a href="./12-impl-mmio.html">3 Memory-mapped I/Oの実装</a></li>
    <li class="toc-chapter"><a href="./13-impl-a.html">4 A拡張の実装</a></li>
    <li class="toc-chapter"><a href="./14-impl-c.html">5 C拡張の実装</a></li>
  </ul>
</li>
<li class="toc-part">第II部 特権/割り込みの実装
  <ul class="toc toc-2">
    <li class="toc-chapter"><a href="./20-mmode-csr.html">6 M-modeの実装 (1. CSRの実装)</a>
      <ul class="toc toc-3">
        <li class="toc-section"><a href="./20-mmode-csr.html#h6-1">6.1 概要</a></li>
        <li class="toc-section"><a href="./20-mmode-csr.html#h6-2">6.2 CSRのアドレスの定義</a></li>
        <li class="toc-section"><a href="./20-mmode-csr.html#h6-3">6.3 misaレジスタ (Machine ISA)</a></li>
        <li class="toc-section"><a href="./20-mmode-csr.html#h6-4">6.4 mimpidレジスタ (Machine Implementation ID)</a></li>
        <li class="toc-section"><a href="./20-mmode-csr.html#h6-5">6.5 mhartidレジスタ (Hart ID)</a></li>
        <li class="toc-section"><a href="./20-mmode-csr.html#h6-6">6.6 mstatusレジスタ (Machine Status)</a></li>
        <li class="toc-section"><a href="./20-mmode-csr.html#h6-7">6.7 ハードウェアパフォーマンスモニタ</a></li>
        <li class="toc-section"><a href="./20-mmode-csr.html#h6-8">6.8 mscratchレジスタ (Machine Scratch)</a></li>
      </ul>
    </li>
    <li class="toc-chapter"><a href="./21-impl-interrupt.html">7 M-modeの実装 (2. 割り込みの実装)</a></li>
    <li class="toc-chapter"><a href="./22-umode-csr.html">8 U-modeの実装</a></li>
    <li class="toc-chapter"><a href="./23-smode-csr.html">9 S-modeの実装 (1. CSRの実装)</a></li>
    <li class="toc-chapter"><a href="./24-impl-paging.html">10 S-modeの実装 (2. 仮想記憶システム)</a></li>
    <li class="toc-chapter"><a href="./25-impl-plic.html">11 PLICの実装</a></li>
    <li class="toc-chapter"><a href="./26-run-linux.html">12 Linuxを動かす</a></li>
  </ul>
</li>
    <li class="toc-chapter"><a href="./99b-postface.html">あとがき</a></li>
</ul>
      </div>
      <div class="page-inner">
        <header class="page-header">
        </header>
        <main class="page-main">
  <h1 class="boldlines center twolines"><a id="h6"></a><span class="secno">第6章</span> <br/>M-modeの実装 (1. CSRの実装)</h1>

<h2 class="numbox"><a id="h6-1"></a><span class="secno">6.1</span> 概要</h2>
<p>「第II部 RV64IMACの実装」では、RV64IMACと例外、メモリマップドI/Oを実装しました。「第III部 特権/割り込みの実装」では、次のような機能を実装します。</p>
<ul>
<li>特権レベル (M-mode、S-mode、U-mode)
</li>
<li>仮想記憶システム(ページング)
</li>
<li>割り込み(CLINT、PLIC)
</li>
</ul>
<p>これらの機能を実装したCPUはOSを動かすための十分な機能を持っています。第III部の最後ではLinuxを動作させます。</p>

<h3 class="none"><a id="h6-1-1"></a><span class="secno">6.1.1</span> 特権レベルとは何か？</h3>
<p>CPUで動くアプリケーションは様々ですが、多くのアプリケーションはOS(Operating System、オペレーティングシステム)の上で動くように作成されています。「OSの上で動く」とは、アプリケーションはOSの機能を使い、OSに管理されながら実行されるということです。</p>
<p>多くのOSはデバイスやメモリなどのリソースの管理を行い、簡単にそれを扱うためのインターフェースをアプリケーションに提供します。また、アプリケーションのデータを別のアプリケーションから保護したり、OSが提供する方法でしかデバイスにアクセスできなくするセキュリティ機能も備えています。</p>
<p>セキュリティ機能を実現するためには、OSがアプリケーションを実行するときにCPUが提供する一部の機能を制限する機能が必要です。RISC-Vでは、この機能を特権レベル(privilege level)という機能、枠組みによって提供しています。ほとんどの特権レベルの機能はCSRを通じて提供されます。</p>
<p>特権レベルは次の3種類<sup><a id="fnb-virtualization" href="#fn-virtualization" class="noteref" epub:type="noteref">*1</a></sup>が用意されています(TODO table)。それぞれの特権レベルは2ビットの数値で表すことができます。</p>
<p>TODO table 高い低い</p>
<div class="footnote-list">
<div class="footnote" id="fn-virtualization" epub:type="footnote"><p class="footnote"><span class="footnote-mark">[*1] </span>V拡張が実装されている場合、さらに仮想化のための特権レベルが定義されます。</p></div>
</div><!--/.footnote-list-->
<p>高い特権レベルには低い特権レベルの機能を制限する機能があったり、高い特権レベルでしか利用できない機能が定義されています。</p>
<p>特権レベルを表す<code class="inline-code">PrivMode</code>型をeeiパッケージに定義してください()。</p>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>

<h3 class="none"><a id="h6-1-2"></a><span class="secno">6.1.2</span> 特権レベルの実装順序</h3>
<p>RISC-VのCPUに特権レベルを実装するとき、TODOテーブルのいずれかの構成にする必要があります。特権レベルを実装していないときはM-modeだけが実装されているように扱います。</p>
<p>TODO M, MU, MSUテーブルと章</p>
<p>CPUがリセット(起動)したときの特権レベルはM-modeです。現在の特権レベルを保持するレジスタをcsrunitモジュールに作成します()。</p>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>
<p>本章ではM-mode向けのCSRの一部を実装します。実装する機能、レジスタと章の対応は表TODOの通りです</p>
<p>table 実装する機能とレジスタと章の対応</p>

<h3 class="none"><a id="h6-1-3"></a><span class="secno">6.1.3</span> XLENの定義</h3>
<p>M-modeのCSRの多くは、特権レベルがM-modeのときのXLENであるMXLENをビット幅として定義されています。S-mode、U-modeのときのXLENはそれぞれSXLEN、UXLENと定義されており、MXLEN &gt;= SXLEN &gt;= UXLENを満たす必要があります。仕様上はmstatusレジスタを使用してSXLEN、UXLENを変更できるように実装できますが、本書ではMXLEN、SXLEN、UXLENが常に<code class="inline-code">64</code>(eeiパッケージに定義しているXLEN)になるように実装します。</p>

<h2 class="numbox"><a id="h6-2"></a><span class="secno">6.2</span> CSRのアドレスの定義</h2>
<p>本書で実装するM-modeのCSRのアドレスをすべて定義します()。</p>
<p>TODO mcounteren</p>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>

<h2 class="numbox"><a id="h6-3"></a><span class="secno">6.3</span> misaレジスタ (Machine ISA)</h2>
<p>TODO 図</p>
<p>misaレジスタは、ハードウェアスレッドがサポートするISAを表すMXLENビットのレジスタです。MXLフィールドにはMXLENを表す数値(table TODO)が格納されています。Extensionsフィールドは下位ビットからそれぞれアルファベットのA、B、 Cと対応していて、それぞれのビットはそのアルファベットが表す拡張(例えばA拡張ならAビット、C拡張ならC)が実装されているなら<code class="inline-code">1</code>に設定されています。仕様上はExtensionsフィールドを書き換えられるように実装できますが、本書では書き換えられないようにします。</p>
<p>misaレジスタを作成し、読み込めるようにします()。CPUは<code class="inline-code">RV64IMAC</code>なのでMXLフィールドに<code class="inline-code">64</code>を表す<code class="inline-code">2</code>を設定し、ExtensionsフィールドのM拡張(M)、基本整数命令セット(I)、C拡張(C)、A拡張(A)のビットを<code class="inline-code">1</code>にしています。</p>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>
<p>これ以降、AというCSRのBフィールド、ビットのことをA.Bと表記することがあります。</p>

<h2 class="numbox"><a id="h6-4"></a><span class="secno">6.4</span> mimpidレジスタ (Machine Implementation ID)</h2>
<p>TODO 図</p>
<p>mimpidレジスタは、プロセッサ実装のバージョンを表す値を格納しているMXLENビットのレジスタです。値が<code class="inline-code">0</code>のときは、mimpidレジスタが実装されていないことを示します。</p>
<p>他にもプロセッサの実装の情報を表すレジスタ(mvendorid<sup><a id="fnb-mvendorid" href="#fn-mvendorid" class="noteref" epub:type="noteref">*2</a></sup>、marchid<sup><a id="fnb-marchid" href="#fn-marchid" class="noteref" epub:type="noteref">*3</a></sup>)がありますが、本書では実装しません。</p>
<div class="footnote-list">
<div class="footnote" id="fn-mvendorid" epub:type="footnote"><p class="footnote"><span class="footnote-mark">[*2] </span>製造業者のID(JEDEC ID)を格納します</p></div>
<div class="footnote" id="fn-marchid" epub:type="footnote"><p class="footnote"><span class="footnote-mark">[*3] </span>マイクロアーキテクチャの種類を示すIDを格納します</p></div>
</div><!--/.footnote-list-->
<p>せっかくなので、適当な値を設定しましょう。eeiパッケージにIDを定義して、読み込めるようにします()。</p>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>

<h2 class="numbox"><a id="h6-5"></a><span class="secno">6.5</span> mhartidレジスタ (Hart ID)</h2>
<p>TODO 図</p>
<p>mhartidレジスタは、今実行しているハードウェアスレッド(hart)のIDを格納しているMXLENビットのレジスタです。複数のプロセッサ、ハードウェアスレッドが存在するときに、それぞれを区別するために使用できます。IDはどんな値でも良いですが、IDが<code class="inline-code">0</code>のハードウェアスレッドが1つ存在する必要があります。基本編で作るCPUは1コア1ハードウェアスレッドであるためmhartidレジスタに0を設定します。</p>
<p>mhart変数を作成し、読み込めるようにします()。</p>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>

<h2 class="numbox"><a id="h6-6"></a><span class="secno">6.6</span> mstatusレジスタ (Machine Status)</h2>
<p>TODO 図</p>
<p>mstatusレジスタは、拡張の設定やトラップ、状態などを管理するMXLENビットのレジスタです。基本編ではTODO 図に示しているフィールドを、そのフィールドが必要になったときに実装します。とりあえず今のところは読み込みだけできるようにしておきます()。</p>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>

<h2 class="numbox"><a id="h6-7"></a><span class="secno">6.7</span> ハードウェアパフォーマンスモニタ</h2>
<p>RISC-Vには、ハードウェアの性能評価指標を得るためにmcycleとminstret、それぞれ29個のmhpmcounter、mhpmeventレジスタが定義されています。それぞれ次の値を得るために利用できます。</p>
<dl>
<dt>mcycleレジスタ (64ビット)</dt>
<dd>
    ハードウェアスレッドが起動(リセット)されてから経過したサイクル数
</dd>
<dt>minstretレジスタ (64ビット)</dt>
<dd>
    ハードウェアスレッドがリタイア(実行完了)した命令数
</dd>
<dt>mhpmcounter、mhpmeventレジスタ (64ビット)</dt>
<dd>
    mhpmeventレジスタで選択された指標がmhpmcounterレジスタに反映されます。
</dd>
</dl>
<p>基本編ではmcycle、minstretレジスタを実装します。mhpmcounter、mhpmeventレジスタは表示するような指標がないため実装しません。また、mcountinhibitレジスタを使うとカウントを停止するかを制御できますが、これも実装しません。</p>

<h3 class="none"><a id="h6-7-1"></a><span class="secno">6.7.1</span> mcycleレジスタ</h3>
<p>TODO mcycleとminstretを分割</p>
<p>mcycleレジスタを定義し、always_ffブロックで値を更新します()。</p>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>
<p>値を読み込めるようにします()。</p>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>

<h3 class="none"><a id="h6-7-2"></a><span class="secno">6.7.2</span> minstretレジスタ</h3>
<p>coreモジュールでinstretレジスタを作成し、トラップが発生していない命令がWBステージに到達した場合にインクリメントさせます()。csrunitモジュールはトラップではないMRET命令でも<code class="inline-code">raise_trap</code>フラグを立てているため、MRET命令でもインクリメントするために<code class="inline-code">trap_return</code>フラグを実装しています()。</p>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>
<p>TODO ここでリファクタリングする</p>

<h2 class="numbox"><a id="h6-8"></a><span class="secno">6.8</span> mscratchレジスタ (Machine Scratch)</h2>
<p>mscratchレジスタは、M-modeのときに自由に読み書きできるMXLENビットのレジスタです。</p>
<p>mscratchレジスタの典型的な用途はコンテキストスイッチです。コンテキストスイッチとは、実行しているアプリケーションAを別のアプリケーションBに切り替えることを指します。多くの場合、コンテキストスイッチはトラップによって開始しますが、Aの実行途中の状態(レジスタの値)を保存しないとAを実行再開できなくなります。そのため、コンテキストスイッチが始まったとき、つまりトラップが発生したときにレジスタの値をメモリに保存する必要があります。しかし、ストア命令はアドレスの指定にレジスタの値を使うため、アドレスの指定のために少なくとも1つのレジスタの値を犠牲にしなければならず、すべてのレジスタの値を保存できません<sup><a id="fnb-save-near-zero" href="#fn-save-near-zero" class="noteref" epub:type="noteref">*4</a></sup>()。</p>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>
<div class="footnote-list">
<div class="footnote" id="fn-save-near-zero" epub:type="footnote"><p class="footnote"><span class="footnote-mark">[*4] </span>x0と即値を使うとアドレス0付近にすべてのレジスタの値を保存できますが、一般的な方法ではなく、動的に場所を変更するのも難しいです</p></div>
</div><!--/.footnote-list-->
<p>この問題を回避するために、一時的な値の保存場所としてmscratchレジスタが使用されます()。事前にmscratchレジスタにメモリアドレス(やメモリアドレスを得るための情報)を格納しておき、CSRRW命令でmscratchレジスタの値とレジスタの値を交換することで任意の場所にレジスタを保存できます。</p>
<p>mscratchレジスタを定義し、自由に読み書きできるようにします()。</p>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>
<div class="caption-code">
<pre class="emlist">
</pre>
</div>
        </main>
        <nav class="page-navi">
          <a href="14-impl-c.html" class="page-prev">&#9664;</a>
          <a href="21-impl-interrupt.html" class="page-next">&#9654;</a>
        </nav>
        <br>
        <br>
        <footer style="background:#dddddd">
      <div style="padding: 20px 20px 20px 20px;">
          <div style="font-size:1.4rem"><b>コンピュータは、CPUを書けば理解できる！</b></div><br>
          コンピュータアーキテクチャはCPUを作れば理解できます。
          「Verylで作るCPU」は、ハードウェア記述言語VerylでRISC-VのCPUを自作する方法を解説するプロジェクトです。<br>
          「Verylで作るCPU 基本編」では、ハードウェア記述言語の基礎から、OSを実行できる程度のCPUの実装方法までを解説します。<br>
          <br>
          キーワード: 自作CPU , RISC-V , Veryl , FPGA<br>
      <div>
        </footer>
      </div>
    </div>
    
    <script>
      let url = window.location.href;
      let encoded_url = encodeURI(url);
      let fb = document.getElementById("share-facebook");
      fb["data-href"] = url;
      console.log(fb);
    </script>
    <div id="fb-root"></div>
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v21.0"></script>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

  </body>
</html>
<!-- layout.html5.erb -->
