<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>riscv-testsによるテスト | Verylで作るCPU</title>
    <meta name="description" content="Write RISC-V CPU in Veryl">
    <meta name="generator" content="VitePress v2.0.0-alpha.12">
    <link rel="preload stylesheet" href="/assets/style.C620yUbE.css" as="style">
    <link rel="preload stylesheet" href="/vp-icons.css" as="style">
    
    <script type="module" src="/assets/app.COvJ4RPU.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/theme.UaZGrBey.js">
    <link rel="modulepreload" href="/assets/chunks/framework.BNheOMQd.js">
    <link rel="modulepreload" href="/assets/04b-riscvtests.md.oxWN38vg.lean.js">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EM6HSGNSVY"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EM6HSGNSVY");</script>
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-1df9f90f><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0b0ada53></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0b0ada53>Skip to content</a><!--]--><!----><header class="VPNav" data-v-1df9f90f data-v-9f75dce3><div class="VPNavBar" data-v-9f75dce3 data-v-2a96a3d0><div class="wrapper" data-v-2a96a3d0><div class="container" data-v-2a96a3d0><div class="title" data-v-2a96a3d0><div class="VPNavBarTitle has-sidebar" data-v-2a96a3d0 data-v-1e38c6bc><a class="title" href="/" data-v-1e38c6bc><!--[--><!--]--><!----><span data-v-1e38c6bc>Verylで作るCPU</span><!--[--><!--]--></a></div></div><div class="content" data-v-2a96a3d0><div class="content-body" data-v-2a96a3d0><!--[--><!--]--><div class="VPNavBarSearch search" data-v-2a96a3d0><!--[--><!----><div id="local-search"><button type="button" aria-label="Search" aria-keyshortcuts="/ control+k meta+k" class="DocSearch DocSearch-Button"><span class="DocSearch-Button-Container"><span class="vpi-search DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key"></kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-2a96a3d0 data-v-39714824><span id="main-nav-aria-label" class="visually-hidden" data-v-39714824> Main Navigation </span><!--[--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-2a96a3d0 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-2a96a3d0 data-v-0394ad82 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://github.com/nananapo/veryl-riscv-book" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-2a96a3d0 data-v-bb2aa2f0 data-v-42cb505d><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-42cb505d><span class="vpi-more-horizontal icon" data-v-42cb505d></span></button><div class="menu" data-v-42cb505d><div class="VPMenu" data-v-42cb505d data-v-25a6cce8><!----><!--[--><!--[--><!----><div class="group" data-v-bb2aa2f0><div class="item appearance" data-v-bb2aa2f0><p class="label" data-v-bb2aa2f0>Appearance</p><div class="appearance-action" data-v-bb2aa2f0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bb2aa2f0 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><div class="group" data-v-bb2aa2f0><div class="item social-links" data-v-bb2aa2f0><div class="VPSocialLinks social-links-list" data-v-bb2aa2f0 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://github.com/nananapo/veryl-riscv-book" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-2a96a3d0 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-2a96a3d0><div class="divider-line" data-v-2a96a3d0></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-1df9f90f data-v-8acdfeb5><div class="container" data-v-8acdfeb5><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-8acdfeb5><span class="vpi-align-left menu-icon" data-v-8acdfeb5></span><span class="menu-text" data-v-8acdfeb5>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-8acdfeb5 data-v-0bf0e06f><button data-v-0bf0e06f>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-1df9f90f data-v-e7c6e512><div class="curtain" data-v-e7c6e512></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-e7c6e512><span class="visually-hidden" id="sidebar-aria-label" data-v-e7c6e512> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0 has-active" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>第I部 RV32I/RV64Iの実装</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/00-preface.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>まえがき</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/02-setup.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>1 環境構築</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/03-veryl.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>2 ハードウェア記述言語 Veryl</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/04-impl-rv32i.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>3 RV32Iの実装</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/04a-zicsr.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>4 Zicsr拡張の実装</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/04b-riscvtests.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>5 riscv-testsによるテスト</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/05-impl-rv64i.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>6 RV64Iの実装</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/05a-pipeline.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>7 CPUのパイプライン化</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/05b-synth.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>8 CPUの合成</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>第II部 RV64IMACの実装</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/10-impl-m.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>9 M拡張の実装</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/11-impl-exception.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>10 例外の実装</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/12-impl-mmio.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>11 Memory-mapped I/Oの実装</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/13-impl-a.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>12 A拡張の実装</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/14-impl-c.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>13 C拡張の実装</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>第III部 特権/割り込みの実装</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/20-mmode-csr.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>14 M-modeの実装 (1. CSRの実装)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/21-impl-interrupt.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>15 M-modeの実装 (2. 割り込みの実装)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/22-umode-csr.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>16 U-modeの実装</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/23-smode-csr.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>17 S-modeの実装 (1. CSRの実装)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/24-impl-paging.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>18 S-modeの実装 (2. 仮想記憶システム)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/25-impl-plic.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>19 PLICの実装</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/26-run-linux.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>20 Linuxを動かす</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/99-postface.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>あとがき (第Ⅰ部)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/99b-postface.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>あとがき (第Ⅱ部、第Ⅲ部)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/100-contribute.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>このプロジェクトに貢献する</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-1df9f90f data-v-aff0b8d7><div class="VPDoc has-sidebar has-aside" data-v-aff0b8d7 data-v-7011f0d8><!--[--><!--]--><div class="container" data-v-7011f0d8><div class="aside" data-v-7011f0d8><div class="aside-curtain" data-v-7011f0d8></div><div class="aside-container" data-v-7011f0d8><div class="aside-content" data-v-7011f0d8><div class="VPDocAside" data-v-7011f0d8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-60d5052e><div class="content" data-v-60d5052e><div class="outline-marker" data-v-60d5052e></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-60d5052e>On this page</div><ul class="VPDocOutlineItem root" data-v-60d5052e data-v-2d0bdf9b><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-7011f0d8><div class="content-container" data-v-7011f0d8><!--[--><!--]--><main class="main" data-v-7011f0d8><div style="position:relative;" class="vp-doc _04b-riscvtests" data-v-7011f0d8><div><h1 id="riscv-testsによるテスト" tabindex="-1">riscv-testsによるテスト <a class="header-anchor" href="#riscv-testsによるテスト" aria-label="Permalink to “riscv-testsによるテスト”">​</a></h1><p>第3章では、RV32IのCPUを実装しました。 簡単なテストを作成して動作を確かめましたが、 まだテストできていない命令が複数あります。 そこで、riscv-testsというテストを利用することで、 CPUがある程度正しく動いているらしいことを確かめます。</p><h2 id="riscv-testsとは何か" tabindex="-1">riscv-testsとは何か? <a class="header-anchor" href="#riscv-testsとは何か" aria-label="Permalink to “riscv-testsとは何か?”">​</a></h2><p>riscv-testsは、RISC-Vのプロセッサ向けのユニットテストやベンチマークテストの集合です。 命令や機能ごとにテストが用意されており、 これを利用することで簡単に実装を確かめられます。 すべての命令のすべての場合を網羅するようなテストではないため、 riscv-testsをパスしても、確実に実装が正しいとは言えないことに注意してください<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>。</p><p>GitHubの<a href="https://github.com/riscv-software-src/riscv-tests" target="_blank" rel="noreferrer">riscv-software-src/riscv-tests</a> からソースコードをダウンロードできます。</p><h2 id="riscv-testsのビルド" tabindex="-1">riscv-testsのビルド <a class="header-anchor" href="#riscv-testsのビルド" aria-label="Permalink to “riscv-testsのビルド”">​</a></h2><div class="info custom-block"><p class="custom-block-title"><b>riscv-testsのビルドが面倒、もしくはよく分からなくなってしまった方へ</b></p><p><a href="https://github.com/nananapo/riscv-tests-bin/tree/bin4" target="_blank" rel="noreferrer">https://github.com/nananapo/riscv-tests-bin/tree/bin4</a></p><p>完成品を上記のURLにおいておきます。 core/testにコピーしてください。</p></div><h3 id="riscv-testsをビルドする" tabindex="-1">riscv-testsをビルドする <a class="header-anchor" href="#riscv-testsをビルドする" aria-label="Permalink to “riscv-testsをビルドする”">​</a></h3><p>まず、riscv-testsをcloneします (リスト1)。</p><p><span class="caption">▼リスト5.1: riscv-testsのclone</span></p><div class="language-terminal"><button title="Copy Code" class="copy"></button><span class="lang">terminal</span><pre class="hljs"><code><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://github.com/riscv-software-src/riscv-tests</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> riscv-tests</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">git submodule update --init --recursive</span>
</code></pre></div><p>riscv-testsは、 プログラムの実行が<code>0x80000000</code>から始まると仮定した設定になっています。 しかし、CPUはアドレス<code>0x00000000</code>から実行を開始するため、 リンカにわたす設定ファイル<code>env/p/link.ld</code>を変更する必要があります(リスト2)。</p><p><span class="caption">▼リスト5.2: riscv-tests/env/p/link.ld</span></p><div class="language-ld"><button title="Copy Code" class="copy"></button><span class="lang">ld</span><pre class="hljs"><code>OUTPUT_ARCH( &quot;riscv&quot; )
ENTRY(_start)

SECTIONS
{
  . = <span class="custom-hl-bold">0x00000000</span>; ← 先頭を0x00000000に変更する
</code></pre></div><p>riscv-testsをビルドします。 必要なソフトウェアがインストールされていない場合、適宜インストールしてください (リスト3)。</p><p><span class="caption">▼リスト5.3: riscv-testsのビルド</span></p><div class="language-terminal"><button title="Copy Code" class="copy"></button><span class="lang">terminal</span><pre class="hljs"><code><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> riscv-testsを<span class="hljs-built_in">clone</span>したディレクトリ</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">autoconf</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">./configure --prefix=core/testへのパス</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">make</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">make install</span>
</code></pre></div><p>core/testにshareディレクトリが作成されます。</p><h3 id="成果物を-readmemhで読み込める形式に変換する" tabindex="-1">成果物を$readmemhで読み込める形式に変換する <a class="header-anchor" href="#成果物を-readmemhで読み込める形式に変換する" aria-label="Permalink to “成果物を$readmemhで読み込める形式に変換する”">​</a></h3><p>riscv-testsをビルドできましたが、 これは<code>$readmemh</code>システムタスクで読み込める形式(以降HEX形式と呼びます)ではありません。 これをCPUでテストを実行できるように、 ビルドしたテストのバイナリファイルをHEX形式に変換します。</p><p>まず、バイナリファイルをHEX形式に変換するPythonプログラム<code>test/bin2hex.py</code>を作成します(リスト4)。</p><p><span class="caption">▼リスト5.4: test/bin2hex.py</span> <a href="https://github.com/nananapo/bluecore/compare/094eef1c6821781fc253817b65ae682ac335abfc~1..094eef1c6821781fc253817b65ae682ac335abfc#diff-a1287292cbfff133e507279ab22be1d5f258b1a8c04d2f583d30404be4377a82">差分をみる</a></p><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="hljs"><code><span class="hljs-keyword">import</span> sys

<span class="hljs-comment"># 使い方を表示する</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">print_usage</span>():
    <span class="hljs-built_in">print</span>(sys.argv[<span class="hljs-number">1</span>])
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Usage:&quot;</span>, sys.argv[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;[bytes per line] [filename]&quot;</span>)
    exit()

<span class="hljs-comment"># コマンドライン引数を受け取る</span>
args = sys.argv[<span class="hljs-number">1</span>:]
<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args) != <span class="hljs-number">2</span>:
    print_usage()
BYTES_PER_LINE = <span class="hljs-literal">None</span>
<span class="hljs-keyword">try</span>:
    BYTES_PER_LINE = <span class="hljs-built_in">int</span>(args[<span class="hljs-number">0</span>])
<span class="hljs-keyword">except</span>:
    print_usage()
FILE_NAME = args[<span class="hljs-number">1</span>]

<span class="hljs-comment"># バイナリファイルを読み込む</span>
allbytes = []
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(FILE_NAME, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:
    allbytes = f.read()

<span class="hljs-comment"># 値を文字列に変換する</span>
bytestrs = []
<span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> allbytes:
    bytestrs.append(<span class="hljs-built_in">format</span>(b, <span class="hljs-string">&#39;02x&#39;</span>))

<span class="hljs-comment"># 00を足すことでBYTES_PER_LINEの倍数に揃える</span>
bytestrs += [<span class="hljs-string">&quot;00&quot;</span>] * (BYTES_PER_LINE - <span class="hljs-built_in">len</span>(bytestrs) % BYTES_PER_LINE)

<span class="hljs-comment"># 出力</span>
results = []
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(bytestrs), BYTES_PER_LINE):
    s = <span class="hljs-string">&quot;&quot;</span>
    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(BYTES_PER_LINE):
        s += bytestrs[i + BYTES_PER_LINE - j - <span class="hljs-number">1</span>]
    results.append(s)
<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span>.join(results))
</code></pre></div><p>このプログラムは、 第二引数に指定されるバイナリファイルを、 第一引数に与えられた数のバイト毎に区切り、 16進数のテキストで出力します。</p><p>HEXファイルに変換する前に、ビルドした成果物を確認する必要があります。 例えば<code>test/share/riscv-tests/isa/rv32ui-p-add</code>はELFファイル<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>です。 CPUはELFを直接に実行する機能を持っていないため、 <code>riscv64-unknown-elf-objcopy</code>を利用して、 ELFファイルを余計な情報を取り除いたバイナリファイルに変換します(リスト5)。</p><p><span class="caption">▼リスト5.5: ELFファイルをバイナリファイルに変換する</span></p><div class="language-terminal"><button title="Copy Code" class="copy"></button><span class="lang">terminal</span><pre class="hljs"><code><span class="hljs-meta prompt_">$ </span><span class="language-bash">find share/ -<span class="hljs-built_in">type</span> f -not -name <span class="hljs-string">&quot;*.dump&quot;</span> -<span class="hljs-built_in">exec</span> riscv32-unknown-elf-objcopy -O binary {} {}.bin \;</span>
</code></pre></div><p>最後に、objcopyで生成されたバイナリファイルを、 PythonプログラムでHEXファイルに変換します(リスト6)。</p><p><span class="caption">▼リスト5.6: バイナリファイルをHEXファイルに変換する</span></p><div class="language-terminal"><button title="Copy Code" class="copy"></button><span class="lang">terminal</span><pre class="hljs"><code><span class="hljs-meta prompt_">$ </span><span class="language-bash">find share/ -<span class="hljs-built_in">type</span> f -name <span class="hljs-string">&quot;*.bin&quot;</span> -<span class="hljs-built_in">exec</span> sh -c <span class="hljs-string">&quot;python3 bin2hex.py 4 {} &gt; {}.hex&quot;</span> \;</span>
</code></pre></div><h2 id="テスト内容の確認" tabindex="-1">テスト内容の確認 <a class="header-anchor" href="#テスト内容の確認" aria-label="Permalink to “テスト内容の確認”">​</a></h2><p>riscv-testsには複数のテストが用意されていますが、 本章では、名前が<code>rv32ui-p-</code>から始まるRV32I向けのテストを利用します。</p><p>例えば、ADD命令のテストである<code>test/share/riscv-tests/isa/rv32ui-p-add.dump</code>を読んでみます(リスト7)。 <code>rv32ui-p-add.dump</code>は、<code>rv32ui-p-add</code>のダンプファイルです。</p><p><span class="caption">▼リスト5.7: rv32ui-p-add.dump</span></p><div class="language-dump"><button title="Copy Code" class="copy"></button><span class="lang">dump</span><pre class="hljs"><code>Disassembly of section .text.init:

00000000 &lt;_start&gt;:
   0:   0500006f                j       50 &lt;reset_vector&gt;

00000004 &lt;trap_vector&gt;:
   4:   34202f73                csrr    t5,mcause ← t5 = mcause
  ...
  18:   00b00f93                li      t6,11
  1c:   03ff0063                beq     t5,t6,3c &lt;write_tohost&gt;
  ...

0000003c &lt;write_tohost&gt;: ← 0x1000にテスト結果を書き込む
  3c:   00001f17                auipc   t5,0x1
  40:   fc3f2223                sw      gp,-60(t5) # 1000 &lt;tohost&gt;
  ...

00000050 &lt;reset_vector&gt;:
  50:   00000093                li      ra,0
 ...    ← レジスタ値のゼロ初期化
  c8:   00000f93                li      t6,0
 ...    
 130:   00000297                auipc   t0,0x0
 134:   ed428293                addi    t0,t0,-300 # 4 &lt;trap_vector&gt;
 138:   30529073                csrw    mtvec,t0 ← mtvecにtrap_vectorのアドレスを書き込む
 ...    
 178:   00000297                auipc   t0,0x0
 17c:   01428293                addi    t0,t0,20 # 18c &lt;test_2&gt;
 180:   34129073                csrw    mepc,t0 ← mepcにtest_2のアドレスを書き込む
 ...    
 188:   30200073                mret ← mepcのアドレス=test_2にジャンプする

0000018c &lt;test_2&gt;: ← 0 + 0 = 0のテスト
 18c:   00200193                li      gp,2 ← gp = 2
 190:   00000593                li      a1,0
 194:   00000613                li      a2,0
 198:   00c58733                add     a4,a1,a2
 19c:   00000393                li      t2,0
 1a0:   4c771663                bne     a4,t2,66c &lt;fail&gt;
 ...
0000066c &lt;fail&gt;: ← 失敗したときのジャンプ先
 ...
 674:   00119193                sll     gp,gp,0x1 ← gpを1ビット左シフトする
 678:   0011e193                or      gp,gp,1 ← gpのLSBを1にする
 ...
 684:   00000073                ecall

00000688 &lt;pass&gt;: ← すべてのテストに成功したときのジャンプ先
 ...
 68c:   00100193                li      gp,1 ← gp = 1
 690:   05d00893                li      a7,93
 694:   00000513                li      a0,0
 698:   00000073                ecall
 69c:   c0001073                unimp
</code></pre></div><p>命令のテストは次の流れで実行されます。</p><ol><li>_start : reset_vectorにジャンプする。</li><li>reset_vector : 各種状態を初期化する。</li><li>test_* : テストを実行する。命令の結果がおかしかったらfailにジャンプする。最後まで正常に実行できたらpassにジャンプする。</li><li>fail、pass : テストの成否をレジスタに書き込み、trap_vectorにジャンプする。</li><li>trap_vector : write_tohostにジャンプする。</li><li>write_tohost : テスト結果をメモリに書き込む。ここでループする。</li></ol><p><code>_start</code>から実行を開始し、最終的に<code>write_tohost</code>に移動します。 テスト結果はメモリの<code>.tohost</code>に書き込まれます。 <code>.tohost</code>のアドレスは、リンカの設定ファイルに記述されています(リスト8)。 プログラムのサイズは<code>0x1000</code>よりも小さいため、 <code>.tohost</code>のアドレスは<code>0x1000</code>になります。</p><p><span class="caption">▼リスト5.8: riscv-tests/env/p/link.ld</span></p><div class="language-ld"><button title="Copy Code" class="copy"></button><span class="lang">ld</span><pre class="hljs"><code>OUTPUT_ARCH( &quot;riscv&quot; )
ENTRY(_start)

SECTIONS
{
  . = 0x00000000;
  .text.init : { *(.text.init) }
  <span class="custom-hl-bold">. = ALIGN(0x1000);</span>
  <span class="custom-hl-bold">.tohost : { *(.tohost) }</span>
</code></pre></div><h2 id="テストの終了検知" tabindex="-1">テストの終了検知 <a class="header-anchor" href="#テストの終了検知" aria-label="Permalink to “テストの終了検知”">​</a></h2><p>テストを実行するとき、テストの終了を検知して、成功か失敗かを報告する必要があります。</p><p>riscv-testsはテストの終了を示すために、<code>.tohost</code>にLSBが<code>1</code>な値を書き込みます。 書き込まれた値が<code>32&#39;h1</code>のとき、テストが正常に終了したことを表しています。 それ以外のときは、テストが失敗したことを表しています。</p><p>riscv-testsが終了したことを検知する処理をtopモジュールに記述します。 topモジュールでメモリへのアクセスを監視し、 <code>.tohost</code>にLSBが<code>1</code>な値が書き込まれたら、 <code>test_success</code>に結果を書き込んでテストを終了します。 (リスト9)。</p><p><span class="caption">▼リスト5.9: メモリアクセスを監視して終了を検知する (top.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/5d0f3aa1a6136db44ea3b60a5ea092c85cf22fe2~1..5d0f3aa1a6136db44ea3b60a5ea092c85cf22fe2#diff-0c548fd82f89bdf97edffcd89dfccd2aab836eccf57f11b8e25c313abd0d0e6f">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code><span class="hljs-comment">// riscv-testsの終了を検知する</span>
#[ifdef(TEST_MODE)]
<span class="hljs-keyword">always_ff</span> {
    <span class="hljs-keyword">let</span> RISCVTESTS_TOHOST_ADDR: Addr = <span class="hljs-number">&#39;h1000</span> <span class="hljs-keyword">as</span> Addr;
    <span class="hljs-keyword">if</span> d_membus.valid &amp;&amp; d_membus.ready &amp;&amp; d_membus.wen == <span class="hljs-number">1</span> &amp;&amp; d_membus.addr == RISCVTESTS_TOHOST_ADDR &amp;&amp; d_membus.wdata[<span class="hljs-keyword">lsb</span>] == <span class="hljs-number">1&#39;b1</span> {
        test_success = d_membus.wdata == <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> d_membus.wdata == <span class="hljs-number">1</span> {
            $display(<span class="hljs-string">&quot;riscv-tests success!&quot;</span>);
        } <span class="hljs-keyword">else</span> {
            $display(<span class="hljs-string">&quot;riscv-tests failed!&quot;</span>);
            $error  (<span class="hljs-string">&quot;wdata : %h&quot;</span>, d_membus.wdata);
        }
        $finish();
    }
}
</code></pre></div><p><code>test_success</code>はポートとして定義します (リスト10)。</p><p><span class="caption">▼リスト5.10: テスト結果を報告するためのポートを宣言する (top.veryl)</span> <a href="https://github.com/nananapo/bluecore/compare/5d0f3aa1a6136db44ea3b60a5ea092c85cf22fe2~1..5d0f3aa1a6136db44ea3b60a5ea092c85cf22fe2#diff-0c548fd82f89bdf97edffcd89dfccd2aab836eccf57f11b8e25c313abd0d0e6f">差分をみる</a></p><div class="language-veryl"><button title="Copy Code" class="copy"></button><span class="lang">veryl</span><pre class="hljs"><code><span class="hljs-keyword">module</span> top #(
    <span class="hljs-keyword">param</span> MEMORY_FILEPATH_IS_ENV: <span class="hljs-keyword">bit</span>    = <span class="hljs-number">1</span>                 ,
    <span class="hljs-keyword">param</span> MEMORY_FILEPATH       : <span class="hljs-keyword">string</span> = <span class="hljs-string">&quot;MEMORY_FILE_PATH&quot;</span>,
) (
    clk: <span class="hljs-keyword">input</span> <span class="hljs-keyword">clock</span>,
    rst: <span class="hljs-keyword">input</span> <span class="hljs-keyword">reset</span>,
    <span class="custom-hl-bold">#[ifdef(TEST_MODE)]</span>
    <span class="custom-hl-bold">test_success: <span class="hljs-keyword">output</span> <span class="hljs-keyword">bit</span>,</span>
) {
</code></pre></div><p>アトリビュートによって、 終了検知のコードと<code>test_success</code>ポートは <code>TEST_MODE</code>マクロが定義されているときにのみ存在するようになっています。</p><h2 id="テストの実行" tabindex="-1">テストの実行 <a class="header-anchor" href="#テストの実行" aria-label="Permalink to “テストの実行”">​</a></h2><p>試しにADD命令のテストを実行してみましょう。 ADD命令のテストのHEXファイルは<code>test/share/riscv-tests/isa/rv32ui-p-add.bin.hex</code>です。</p><p>TEST_MODEマクロを定義してシミュレータをビルドし、正常に動くことを確認します(リスト11)。</p><p><span class="caption">▼リスト5.11: ADD命令のriscv-testsを実行する</span></p><div class="language-terminal"><button title="Copy Code" class="copy"></button><span class="lang">terminal</span><pre class="hljs"><code><span class="hljs-meta prompt_">$ </span><span class="language-bash">make build</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">make sim VERILATOR_FLAGS=<span class="hljs-string">&quot;-DTEST_MODE&quot;</span> ← TEST_MODEマクロを定義してビルドする</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">./obj_dir/sim <span class="hljs-built_in">test</span>/share/riscv-tests/isa/rv32ui-p-add.bin.hex 0</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">                   4</span>
00000000 : 0500006f
<span class="hljs-meta prompt_"># </span><span class="language-bash">                   8</span>
00000050 : 00000093
...
<span class="hljs-meta prompt_"># </span><span class="language-bash">                 593</span>
00000040 : fc3f2223
  itype     : 000100
  imm       : ffffffc4
  rs1[30]   : 0000103c
  rs2[ 3]   : 00000001
  op1       : 0000103c
  op2       : ffffffc4
  alu res   : 00001000
  mem stall : 1
  mem rdata : ff1ff06f
riscv-tests success!
- ~/core/src/top.sv:26: Verilog $finish
</code></pre></div><p><code>riscv-tests success!</code>と表示され、テストが正常終了しました<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>。</p><h2 id="複数のテストの自動実行" tabindex="-1">複数のテストの自動実行 <a class="header-anchor" href="#複数のテストの自動実行" aria-label="Permalink to “複数のテストの自動実行”">​</a></h2><p>ADD命令以外の命令もテストしたいですが、わざわざコマンドを手打ちしたくありません。 自動でテストを実行して、その結果を報告するプログラムを作成しましょう。</p><p><code>test/test.py</code>を作成し、次のように記述します(リスト12)。</p><p><span class="caption">▼リスト5.12: test.py</span> <a href="https://github.com/nananapo/bluecore/compare/bc8a0d535456481b4cd018ec5d242dd3545db024~1..bc8a0d535456481b4cd018ec5d242dd3545db024#diff-354b34bf98c7e65e1214431540698436073d5e2caf243680551ce1014ba0afde">差分をみる</a></p><div class="language-py"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="hljs"><code><span class="hljs-keyword">import</span> argparse
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> subprocess

parser = argparse.ArgumentParser()
parser.add_argument(<span class="hljs-string">&quot;sim_path&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;path to simlator&quot;</span>)
parser.add_argument(<span class="hljs-string">&quot;dir&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;directory includes test&quot;</span>)
parser.add_argument(<span class="hljs-string">&quot;files&quot;</span>, nargs=<span class="hljs-string">&#39;*&#39;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;test hex file names&quot;</span>)
parser.add_argument(<span class="hljs-string">&quot;-r&quot;</span>, <span class="hljs-string">&quot;--recursive&quot;</span>, action=<span class="hljs-string">&#39;store_true&#39;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;search file recursively&quot;</span>)
parser.add_argument(<span class="hljs-string">&quot;-e&quot;</span>, <span class="hljs-string">&quot;--extension&quot;</span>, default=<span class="hljs-string">&quot;hex&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;test file extension&quot;</span>)
parser.add_argument(<span class="hljs-string">&quot;-o&quot;</span>, <span class="hljs-string">&quot;--output_dir&quot;</span>, default=<span class="hljs-string">&quot;results&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;result output directory&quot;</span>)
parser.add_argument(<span class="hljs-string">&quot;-t&quot;</span>, <span class="hljs-string">&quot;--time_limit&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">float</span>, default=<span class="hljs-number">10</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;limit of execution time. set 0 to nolimit&quot;</span>)
args = parser.parse_args()

<span class="hljs-comment"># run test</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">test</span>(<span class="hljs-params">file_name</span>):
    result_file_path = os.path.join(args.output_dir, file_name.replace(os.sep, <span class="hljs-string">&quot;_&quot;</span>) + <span class="hljs-string">&quot;.txt&quot;</span>)
    cmd = args.sim_path + <span class="hljs-string">&quot; &quot;</span> + file_name + <span class="hljs-string">&quot; 0&quot;</span>
    success = <span class="hljs-literal">False</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(result_file_path, <span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">as</span> f:
        no = f.fileno()
        p = subprocess.Popen(<span class="hljs-string">&quot;exec &quot;</span> + cmd, shell=<span class="hljs-literal">True</span>, stdout=no, stderr=no)
        <span class="hljs-keyword">try</span>:
            p.wait(<span class="hljs-literal">None</span> <span class="hljs-keyword">if</span> args.time_limit == <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> args.time_limit)
            success = p.returncode == <span class="hljs-number">0</span>
        <span class="hljs-keyword">except</span>: <span class="hljs-keyword">pass</span>
        <span class="hljs-keyword">finally</span>:
            p.terminate()
            p.kill()
    <span class="hljs-built_in">print</span>((<span class="hljs-string">&quot;PASS&quot;</span> <span class="hljs-keyword">if</span> success <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;FAIL&quot;</span>) + <span class="hljs-string">&quot; : &quot;</span>+ file_name)
    <span class="hljs-keyword">return</span> (file_name, success)

<span class="hljs-comment"># search files</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">dir_walk</span>(<span class="hljs-params"><span class="hljs-built_in">dir</span></span>):
    <span class="hljs-keyword">for</span> entry <span class="hljs-keyword">in</span> os.scandir(<span class="hljs-built_in">dir</span>):
        <span class="hljs-keyword">if</span> entry.is_dir():
            <span class="hljs-keyword">if</span> args.recursive:
                <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> dir_walk(entry.path):
                    <span class="hljs-keyword">yield</span> e
            <span class="hljs-keyword">continue</span>
        <span class="hljs-keyword">if</span> entry.is_file():
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> entry.name.endswith(args.extension):
                <span class="hljs-keyword">continue</span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args.files) == <span class="hljs-number">0</span>:
                <span class="hljs-keyword">yield</span> entry.path
            <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> args.files:
                <span class="hljs-keyword">if</span> entry.name.find(f) != -<span class="hljs-number">1</span>:
                    <span class="hljs-keyword">yield</span> entry.path
                    <span class="hljs-keyword">break</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#39;__main__&#39;</span>:
    os.makedirs(args.output_dir, exist_ok=<span class="hljs-literal">True</span>)

    res_strs = []
    res_statuses = []

    <span class="hljs-keyword">for</span> hexpath <span class="hljs-keyword">in</span> dir_walk(args.<span class="hljs-built_in">dir</span>):
        f, s = test(os.path.abspath(hexpath))
        res_strs.append((<span class="hljs-string">&quot;PASS&quot;</span> <span class="hljs-keyword">if</span> s <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;FAIL&quot;</span>) + <span class="hljs-string">&quot; : &quot;</span> + f)
        res_statuses.append(s)

    res_strs = <span class="hljs-built_in">sorted</span>(res_strs)
    statusText = <span class="hljs-string">&quot;Test Result : &quot;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">sum</span>(res_statuses)) + <span class="hljs-string">&quot; / &quot;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(res_statuses))

    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(os.path.join(args.output_dir, <span class="hljs-string">&quot;result.txt&quot;</span>), <span class="hljs-string">&quot;w&quot;</span>, encoding=<span class="hljs-string">&#39;utf-8&#39;</span>) <span class="hljs-keyword">as</span> f:
        f.write(statusText + <span class="hljs-string">&quot;\n&quot;</span>)
        f.write(<span class="hljs-string">&quot;\n&quot;</span>.join(res_strs))

    <span class="hljs-built_in">print</span>(statusText)

    <span class="hljs-keyword">if</span> <span class="hljs-built_in">sum</span>(res_statuses) != <span class="hljs-built_in">len</span>(res_statuses):
        exit(<span class="hljs-number">1</span>)
</code></pre></div><p>このPythonプログラムは、 第2引数で指定したディレクトリに存在する、 第3引数で指定した文字列を名前に含むファイルを、 第1引数で指定したシミュレータで実行し、 その結果を報告します。</p><p>次のオプションの引数が存在します。</p><dl><dt>-r</dt><dd> 第2引数で指定されたディレクトリの中にあるディレクトリも走査します。 デフォルトでは走査しません。 </dd><dt>-e 拡張子</dt><dd> 指定した拡張子のファイルのみを対象にテストします。 HEXファイルをテストしたい場合は、`-e hex`にします。 デフォルトでは`hex`が指定されています。 </dd><dt>-o ディレクトリ</dt><dd> 指定したディレクトリにテスト結果を格納します。 デフォルトでは`result`ディレクトリに格納します。 </dd><dt>-t 時間</dt><dd> テストに時間制限を設けます。 0を指定すると時間制限はなくなります。 デフォルト値は10(秒)です。 </dd></dl><p>テストが成功したか失敗したかの判定には、 シミュレータの終了コードを利用しています。 テストが失敗したときに終了コードが<code>1</code>になるように、 Verilatorに渡しているC++プログラムを変更します (リスト13)。</p><p><span class="caption">▼リスト5.13: tb_verilator.cpp</span> <a href="https://github.com/nananapo/bluecore/compare/5d0f3aa1a6136db44ea3b60a5ea092c85cf22fe2~1..5d0f3aa1a6136db44ea3b60a5ea092c85cf22fe2#diff-cb1447535f2400768c9115df1ccdcc7be37fd2670577cc465b330f5968ee3013">差分をみる</a></p><div class="language-cpp"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="hljs"><code><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> TEST_MODE</span>
    <span class="hljs-keyword">return</span> dut-&gt;test_success != <span class="hljs-number">1</span>;
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
</code></pre></div><p>それでは、RV32Iのテストを実行しましょう。 riscv-testsのRV32I向けのテストの接頭辞である<code>rv32ui-p-</code>を引数に指定します(リスト14)。</p><p><span class="caption">▼リスト5.14: rv32ui-pから始まるテストを実行する</span></p><div class="language-terminal"><button title="Copy Code" class="copy"></button><span class="lang">terminal</span><pre class="hljs"><code><span class="hljs-meta prompt_">$ </span><span class="language-bash">make build</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">make sim VERILATOR_FLAGS=<span class="hljs-string">&quot;-DTEST_MODE&quot;</span></span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">python3 <span class="hljs-built_in">test</span>/test.py -r obj_dir/sim <span class="hljs-built_in">test</span>/share rv32ui-p-</span>
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-lh.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-sb.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-sltiu.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-sh.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-bltu.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-or.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-sra.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-xor.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-addi.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-srai.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-srli.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-auipc.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-slli.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-slti.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-lb.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-lw.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-bge.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-sub.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-xori.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-sw.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-beq.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-fence_i.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-jal.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-and.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-lui.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-bgeu.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-slt.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-sll.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-jalr.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-add.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-simple.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-andi.bin.hex
FAIL : ~/core/test/share/riscv-tests/isa/rv32ui-p-ma_data.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-lhu.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-lbu.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-sltu.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-ori.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-blt.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-bne.bin.hex
PASS : ~/core/test/share/riscv-tests/isa/rv32ui-p-srl.bin.hex
Test Result : 39 / 40
</code></pre></div><p><code>rv32ui-p-</code>から始まる40個のテストの内、39個のテストに成功しました。 テストの詳細な結果はresultsディレクトリに格納されています。</p><p><code>rv32ui-p-ma_data</code>は、 ロードストアするサイズに整列されていないアドレスへのロードストア命令のテストです。 これは後の章で例外として対処するため、今は無視します。</p><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p>実装の正しさを完全に確かめるには形式的検証(formal verification)を行う必要があります <a href="#fnref1" class="footnote-backref">↩︎</a></p></li><li id="fn2" class="footnote-item"><p>ELF(Executable and Linkable Format)とは実行可能ファイルの形式です <a href="#fnref2" class="footnote-backref">↩︎</a></p></li><li id="fn3" class="footnote-item"><p>実行が終了しない場合はどこかしらにバグがあります。rv32ui-p-add.dumpと実行ログを見比べて、頑張って原因を探してください <a href="#fnref3" class="footnote-backref">↩︎</a></p></li></ol></section></div></div></main><footer class="VPDocFooter" data-v-7011f0d8 data-v-e257564d><!--[--><!--]--><!----><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-e257564d><span class="visually-hidden" id="doc-footer-aria-label" data-v-e257564d>Pager</span><div class="pager" data-v-e257564d><a class="VPLink link pager-link prev" href="/04a-zicsr.html" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Previous page</span><span class="title" data-v-e257564d>4 Zicsr拡張の実装</span><!--]--></a></div><div class="pager" data-v-e257564d><a class="VPLink link pager-link next" href="/05-impl-rv64i.html" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Next page</span><span class="title" data-v-e257564d>6 RV64Iの実装</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"00-preface.md\":\"CYEphBX8\",\"02-setup.md\":\"da1pIHNs\",\"03-veryl.md\":\"VOHmUq3V\",\"04-impl-rv32i.md\":\"CoAokrja\",\"04a-zicsr.md\":\"bb6l3EMf\",\"04b-riscvtests.md\":\"oxWN38vg\",\"05-impl-rv64i.md\":\"BeSvLJzL\",\"05a-pipeline.md\":\"DuXYi08s\",\"05b-synth.md\":\"C61u6gEa\",\"10-impl-m.md\":\"-9npfSbI\",\"100-contribute.md\":\"DBSud0cg\",\"11-impl-exception.md\":\"0cjXHDnt\",\"12-impl-mmio.md\":\"DEZ4STaS\",\"13-impl-a.md\":\"VDUHO1Tc\",\"14-impl-c.md\":\"Bh3CTsu3\",\"20-mmode-csr.md\":\"ClifZ5c8\",\"21-impl-interrupt.md\":\"DnjJNNiY\",\"22-umode-csr.md\":\"tKA9gVbB\",\"23-smode-csr.md\":\"CFPGI0fG\",\"24-impl-paging.md\":\"COerDCKH\",\"25-impl-plic.md\":\"c2H7WTzn\",\"26-run-linux.md\":\"BpjxQYJY\",\"99-postface.md\":\"DKyCFrvU\",\"99b-postface.md\":\"Cxpm5DbS\",\"index.md\":\"DsKG6qhs\"}");function deserializeFunctions(r){return Array.isArray(r)?r.map(deserializeFunctions):typeof r=="object"&&r!==null?Object.keys(r).reduce((t,n)=>(t[n]=deserializeFunctions(r[n]),t),{}):typeof r=="string"&&r.startsWith("_vp-fn_")?new Function(`return ${r.slice(7)}`)():r};window.__VP_SITE_DATA__=deserializeFunctions(JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Verylで作るCPU\",\"description\":\"Write RISC-V CPU in Veryl\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[],\"sidebar\":[{\"text\":\"第I部 RV32I/RV64Iの実装\",\"items\":[{\"text\":\"まえがき\",\"link\":\"/00-preface\"},{\"text\":\"1 環境構築\",\"link\":\"/02-setup\"},{\"text\":\"2 ハードウェア記述言語 Veryl\",\"link\":\"/03-veryl\"},{\"text\":\"3 RV32Iの実装\",\"link\":\"/04-impl-rv32i\"},{\"text\":\"4 Zicsr拡張の実装\",\"link\":\"/04a-zicsr\"},{\"text\":\"5 riscv-testsによるテスト\",\"link\":\"/04b-riscvtests\"},{\"text\":\"6 RV64Iの実装\",\"link\":\"/05-impl-rv64i\"},{\"text\":\"7 CPUのパイプライン化\",\"link\":\"/05a-pipeline\"},{\"text\":\"8 CPUの合成\",\"link\":\"/05b-synth\"}]},{\"text\":\"第II部 RV64IMACの実装\",\"items\":[{\"text\":\"9 M拡張の実装\",\"link\":\"/10-impl-m\"},{\"text\":\"10 例外の実装\",\"link\":\"/11-impl-exception\"},{\"text\":\"11 Memory-mapped I/Oの実装\",\"link\":\"/12-impl-mmio\"},{\"text\":\"12 A拡張の実装\",\"link\":\"/13-impl-a\"},{\"text\":\"13 C拡張の実装\",\"link\":\"/14-impl-c\"}]},{\"text\":\"第III部 特権/割り込みの実装\",\"items\":[{\"text\":\"14 M-modeの実装 (1. CSRの実装)\",\"link\":\"/20-mmode-csr\"},{\"text\":\"15 M-modeの実装 (2. 割り込みの実装)\",\"link\":\"/21-impl-interrupt\"},{\"text\":\"16 U-modeの実装\",\"link\":\"/22-umode-csr\"},{\"text\":\"17 S-modeの実装 (1. CSRの実装)\",\"link\":\"/23-smode-csr\"},{\"text\":\"18 S-modeの実装 (2. 仮想記憶システム)\",\"link\":\"/24-impl-paging\"},{\"text\":\"19 PLICの実装\",\"link\":\"/25-impl-plic\"},{\"text\":\"20 Linuxを動かす\",\"link\":\"/26-run-linux\"},{\"text\":\"あとがき (第Ⅰ部)\",\"link\":\"/99-postface\"},{\"text\":\"あとがき (第Ⅱ部、第Ⅲ部)\",\"link\":\"/99b-postface\"},{\"text\":\"このプロジェクトに貢献する\",\"link\":\"/100-contribute\"}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/nananapo/veryl-riscv-book\"}],\"outline\":{\"level\":[2,4]},\"search\":{\"provider\":\"local\",\"options\":{\"miniSearch\":{\"options\":{\"tokenize\":\"_vp-fn_(term) => {\\n              if (typeof term === \\\"string\\\") term = term.toLowerCase();\\n              const segmenter = Intl.Segmenter && new Intl.Segmenter(\\\"ja-JP\\\", { granularity: \\\"word\\\" });\\n              if (!segmenter) return [term];\\n              const tokens = [];\\n              for (const seg of segmenter.segment(term)) {\\n                if (seg.segment.trim() !== \\\"\\\") tokens.push(seg.segment);\\n              }\\n              return tokens;\\n            }\"}}}}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false,\"additionalConfig\":{}}"));</script>
    
  </body>
</html>